<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>THE REPUBLIC — Data Explorer</title>
<link rel="icon" type="image/svg+xml" href="favicon-index.svg">
<style>
:root{--bg:#0a0a0a;--bg2:#0f0f0f;--bg3:#151515;--panel:#161616;--fg:#e8e8e8;--fg-dim:#a0a0a0;--fg-muted:#606060;--accent:#cc5500;--accent2:#d8a25a;--border:#222;--success:#22c55e}
[data-theme="light"]{--bg:#f5f0e6;--bg2:#ebe5d8;--bg3:#e0dbd0;--panel:#fff;--fg:#1a1a1a;--fg-dim:#4a4a4a;--fg-muted:#888;--accent:#8b4513;--accent2:#a67c52;--border:#d5d0c0}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Courier New',monospace;background:var(--bg);color:var(--fg);transition:background .3s,color .3s}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:9999}
.app{display:flex;flex-direction:column;height:100%}

/* Hub nav */
.hub-nav{display:flex;gap:4px;flex-wrap:wrap;padding:8px 12px;background:var(--bg2);border-bottom:1px solid var(--border)}
.hub-link{font-size:8px;padding:5px 8px;background:var(--bg);border:1px solid var(--border);border-radius:3px;color:var(--fg-dim);text-decoration:none;text-transform:uppercase;letter-spacing:.03em;transition:all .15s;white-space:nowrap}
.hub-link:hover,.hub-link:active{border-color:var(--accent);color:var(--accent)}
.hub-link.current{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Header */
header{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.logo{font-size:13px;font-weight:700;color:var(--accent);display:flex;align-items:center;gap:6px}
.logo svg{width:16px;height:16px}
.search{flex:1;min-width:150px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--fg);font:inherit;font-size:11px}
.search:focus{outline:none;border-color:var(--accent)}
.stats{display:flex;gap:12px;font-size:9px;color:var(--fg-muted)}
.stats b{color:var(--accent)}
.header-actions{display:flex;gap:4px;margin-left:auto}
.icon-btn{width:32px;height:32px;padding:0;background:var(--bg);border:1px solid var(--border);color:var(--fg-muted);cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn svg{width:14px;height:14px}

/* Filters */
.filters{display:flex;gap:6px;padding:8px 12px;background:var(--bg);border-bottom:1px solid var(--border);flex-wrap:wrap}
.filter-btn{font-size:8px;padding:5px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:3px;color:var(--fg-dim);cursor:pointer;transition:all .15s}
.filter-btn:hover{border-color:var(--accent);color:var(--accent)}
.filter-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Main content */
main{flex:1;display:flex;overflow:hidden}
.sidebar{width:240px;border-right:1px solid var(--border);overflow-y:auto;background:var(--panel);flex-shrink:0}
.content{flex:1;overflow-y:auto;padding:12px}

/* Source list */
.source-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}
.source-item:hover{background:var(--bg2)}
.source-item.active{background:var(--bg);border-left:3px solid var(--accent)}
.source-name{font-size:10px;color:var(--fg);margin-bottom:4px;font-weight:600}
.source-count{font-size:9px;color:var(--fg-muted)}
.source-count b{color:var(--accent)}

/* Cards */
.card{background:var(--panel);border:1px solid var(--border);border-radius:4px;margin-bottom:10px;overflow:hidden}
.card-header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:10px;background:var(--bg2)}
.card-idx{font-size:9px;color:var(--fg-muted);background:var(--bg);padding:2px 6px;border-radius:2px;border:1px solid var(--border)}
.card-source{font-size:8px;color:var(--accent2)}
.card-prompt{padding:12px;border-bottom:1px solid var(--border);background:var(--bg)}
.card-prompt-label{font-size:8px;color:var(--accent);text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.card-prompt-text{font-size:10px;line-height:1.6;white-space:pre-wrap;max-height:150px;overflow-y:auto;color:var(--fg-dim)}
.card-completion{padding:12px}
.card-completion-label{font-size:8px;color:var(--accent2);text-transform:uppercase;margin-bottom:6px}
.card-completion-text{font-size:10px;line-height:1.6;white-space:pre-wrap;max-height:300px;overflow-y:auto;color:var(--fg)}
.btn-copy{font-size:8px;padding:4px 10px;background:var(--bg);border:1px solid var(--border);color:var(--fg-muted);border-radius:3px;cursor:pointer;transition:all .15s}
.btn-copy:hover{border-color:var(--accent);color:var(--accent)}

/* Empty & loading */
.empty{text-align:center;padding:60px 20px;color:var(--dim)}
.loading{text-align:center;padding:40px;color:var(--dim)}

/* Toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--amber);color:var(--bg);padding:10px 20px;border-radius:4px;font-size:11px;opacity:0;transition:all .3s;z-index:200}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* Mobile */
@media(max-width:768px){
  .sidebar{display:none}
  .filters{overflow-x:auto;flex-wrap:nowrap}
  header{flex-direction:column;align-items:stretch}
  .stats{justify-content:center}
}
</style>
</head>
<body>
<div class="app">
<nav class="hub-nav">
<a href="index-splash.html" class="hub-link">Splash</a>
<a href="index.html" class="hub-link">Ledger</a>
<a href="screenplay-assembly.html" class="hub-link">Assembly</a>
<a href="screenplay.html" class="hub-link">Screenplay</a>
<a href="onyx-rep.html" class="hub-link current">Explorer</a>
<a href="republic-viewer.html" class="hub-link">Viewer</a>
<a href="compare.html" class="hub-link">Compare</a>
<a href="generate-scripts.html" class="hub-link">Generate</a>
<a href="megamap.html" class="hub-link">Megamap</a>
<a href="treatment.html" class="hub-link">Treatment</a>
</nav>
<header>
<div class="logo">★ DATA EXPLORER</div>
<input type="text" class="search" id="search" placeholder="Search prompts and completions...">
<div class="stats">
<span>Sources: <b id="s-sources">0</b></span>
<span>Prompts: <b id="s-prompts">0</b></span>
<span>Completions: <b id="s-completions">0</b></span>
</div>
</header>
<div class="filters" id="filters"></div>
<main>
<aside class="sidebar" id="sidebar"></aside>
<div class="content" id="content"><div class="loading">Loading data...</div></div>
</main>
</div>
<div class="toast" id="toast"></div>
<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];

const state={
  sources:[],
  items:[],
  activeSource:null,
  filter:''
};

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500);}

function extract(data,fname){
  const items=[];
  const title=data.metadata?.title||fname.replace('.json','');
  
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        const prompt=m.say;
        let completion='';
        if(data.messages[i+1]?.role==='Response')completion=data.messages[i+1].say||'';
        items.push({prompt,completion,source:title,fname});
      }
    }
  }
  
  if(Array.isArray(data)){
    for(const r of data){
      const p=r.prompt||r.input||r.request?.prompt||(r.messages?r.messages.map(m=>`${m.role}:${m.content}`).join('\n'):'');
      const c=r.completion||r.response||r.output||r.choices?.[0]?.message?.content||r.choices?.[0]?.text||'';
      if(p)items.push({prompt:p,completion:c,source:title,fname});
    }
  }
  
  return{fname,title,items,count:items.length};
}

function renderSidebar(){
  let html='<div class="source-item'+(state.activeSource===null?' active':'')+'" data-src="all"><div class="source-name">All Sources</div><div class="source-count"><b>'+state.items.length+'</b> items</div></div>';
  for(const src of state.sources){
    const active=state.activeSource===src.fname?' active':'';
    html+='<div class="source-item'+active+'" data-src="'+src.fname+'"><div class="source-name">'+esc(src.title)+'</div><div class="source-count"><b>'+src.count+'</b> prompts</div></div>';
  }
  $('#sidebar').innerHTML=html;
  $$('.source-item').forEach(el=>el.onclick=()=>{
    state.activeSource=el.dataset.src==='all'?null:el.dataset.src;
    renderSidebar();
    renderContent();
  });
}

function renderFilters(){
  let html='<button class="filter-btn'+(state.activeSource===null?' active':'')+'" data-src="all">All</button>';
  for(const src of state.sources){
    const active=state.activeSource===src.fname?' active':'';
    html+='<button class="filter-btn'+active+'" data-src="'+src.fname+'">'+esc(src.title.slice(0,15))+'</button>';
  }
  $('#filters').innerHTML=html;
  $$('.filter-btn').forEach(el=>el.onclick=()=>{
    state.activeSource=el.dataset.src==='all'?null:el.dataset.src;
    renderSidebar();
    renderFilters();
    renderContent();
  });
}

function renderContent(){
  const q=state.filter.toLowerCase();
  let filtered=state.items;
  
  if(state.activeSource){
    filtered=filtered.filter(x=>x.fname===state.activeSource);
  }
  if(q){
    filtered=filtered.filter(x=>x.prompt.toLowerCase().includes(q)||x.completion.toLowerCase().includes(q));
  }
  
  if(!filtered.length){
    $('#content').innerHTML='<div class="empty">No items match your criteria.</div>';
    return;
  }
  
  let html='';
  filtered.forEach((item,i)=>{
    const promptPreview=item.prompt.split('\n')[0].slice(0,100);
    html+='<div class="card">';
    html+='<div class="card-header"><span class="card-idx">#'+String(i+1).padStart(3,'0')+'</span><span class="card-source">'+esc(item.source)+'</span></div>';
    html+='<div class="card-prompt"><div class="card-prompt-label">★ Prompt <button class="btn-copy" data-type="prompt" data-idx="'+i+'">Copy</button></div><div class="card-prompt-text">'+esc(item.prompt)+'</div></div>';
    if(item.completion){
      html+='<div class="card-completion"><div class="card-completion-label">Response <button class="btn-copy" data-type="completion" data-idx="'+i+'">Copy</button></div><div class="card-completion-text">'+esc(item.completion)+'</div></div>';
    }
    html+='</div>';
  });
  
  $('#content').innerHTML=html;
  
  $$('.btn-copy').forEach(btn=>btn.onclick=e=>{
    e.stopPropagation();
    const idx=+btn.dataset.idx;
    const type=btn.dataset.type;
    const items=getFiltered();
    if(!items[idx])return;
    const text=type==='prompt'?items[idx].prompt:items[idx].completion;
    if(navigator.clipboard&&navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(()=>toast('Copied!')).catch(()=>toast('Copy failed'));
    }else{
      // Fallback for older browsers
      const ta=document.createElement('textarea');
      ta.value=text;ta.style.position='fixed';ta.style.opacity='0';
      document.body.appendChild(ta);ta.select();
      try{document.execCommand('copy');toast('Copied!');}catch(e){toast('Copy failed');}
      document.body.removeChild(ta);
    }
  });
}

function getFiltered(){
  const q=state.filter.toLowerCase();
  let filtered=state.items;
  if(state.activeSource)filtered=filtered.filter(x=>x.fname===state.activeSource);
  if(q)filtered=filtered.filter(x=>x.prompt.toLowerCase().includes(q)||x.completion.toLowerCase().includes(q));
  return filtered;
}

function updateStats(){
  $('#s-sources').textContent=state.sources.length;
  $('#s-prompts').textContent=state.items.length;
  let completions=0;
  state.items.forEach(x=>{if(x.completion)completions++;});
  $('#s-completions').textContent=completions;
}

async function loadData(){
  $('#content').innerHTML='<div class="loading">Loading sources...</div>';
  let loaded=0,failed=0;
  
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok){failed++;continue;}
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.items.length){
        state.sources.push(ex);
        state.items.push(...ex.items);
        loaded++;
      }
    }catch(e){
      console.error('Failed to load',fn,e);
      failed++;
    }
  }
  
  if(state.items.length===0){
    $('#content').innerHTML='<div class="empty">No data loaded. Make sure JSON files are accessible.<br><small style="color:var(--dim)">Loaded: '+loaded+' / Failed: '+failed+'</small></div>';
    return;
  }
  
  updateStats();
  renderSidebar();
  renderFilters();
  renderContent();
}

$('#search').oninput=e=>{
  state.filter=e.target.value;
  renderContent();
};

loadData();
</script>
</body>
</html>
