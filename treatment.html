<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THE REPUBLIC â€” Script Treatments</title>
<link rel="icon" type="image/svg+xml" href="favicon-treatment.svg">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:#0a0a0a;color:#c4c4c4;font-size:13px;line-height:1.7}
.header{position:fixed;top:0;left:0;right:0;height:48px;background:#050505;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:100}
.logo{font-size:12px;color:#cc5500;letter-spacing:.1em}
.nav{display:flex;gap:16px}
.nav-btn{font-size:10px;padding:6px 12px;background:none;border:1px solid #333;color:#666;cursor:pointer;transition:all .2s}
.nav-btn:hover{border-color:#cc5500;color:#cc5500}
.nav-btn.active{background:#cc5500;border-color:#cc5500;color:#000}
.container{max-width:900px;margin:0 auto;padding:68px 20px 40px}
.intro{padding:20px;margin-bottom:24px;border:1px solid #222;background:#0f0f0f;font-size:11px;line-height:1.8;color:#666}
.intro-title{font-size:12px;color:#cc5500;margin-bottom:12px;letter-spacing:.1em}
.intro p{margin-bottom:8px}
.intro-toggle{font-size:9px;color:#444;cursor:pointer;margin-top:10px}
.intro-toggle:hover{color:#888}
.stats{display:flex;gap:20px;margin-bottom:24px;padding:16px;background:#0f0f0f;border:1px solid #222}
.stat{text-align:center}
.stat-val{font-size:24px;color:#cc5500}
.stat-label{font-size:9px;color:#555;margin-top:4px;text-transform:uppercase}
.toc{margin-bottom:32px;padding:20px;background:#0f0f0f;border:1px solid #222}
.toc-title{font-size:11px;color:#cc5500;margin-bottom:12px;letter-spacing:.1em}
.toc-item{display:block;padding:8px 0;border-bottom:1px solid #1a1a1a;color:#888;text-decoration:none;font-size:11px;cursor:pointer;transition:color .2s}
.toc-item:hover{color:#cc5500}
.toc-item:last-child{border-bottom:none}
.toc-num{color:#555;margin-right:8px}
.treatment{margin-bottom:48px;padding:24px;background:#0f0f0f;border:1px solid #222;page-break-inside:avoid}
.treatment-header{border-bottom:1px solid #333;padding-bottom:16px;margin-bottom:20px}
.treatment-id{font-size:9px;color:#555;margin-bottom:8px;letter-spacing:.1em}
.treatment-title{font-size:14px;color:#cc5500;line-height:1.4}
.treatment-meta{font-size:9px;color:#555;margin-top:8px}
.section{margin-bottom:24px}
.section-title{font-size:10px;color:#d8a25a;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #222;letter-spacing:.1em;text-transform:uppercase}
.prompt-text{font-size:11px;line-height:1.8;color:#999;white-space:pre-wrap;word-break:break-word;padding:16px;background:#080808;border-left:2px solid #1f4e7a}
.witness{margin-bottom:20px;padding:16px;background:#080808;border-left:2px solid #2d5a3d}
.witness-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #1a1a1a}
.witness-source{font-size:10px;color:#d8a25a}
.witness-num{font-size:9px;color:#555}
.witness-text{font-size:11px;line-height:1.8;color:#bbb;white-space:pre-wrap;word-break:break-word}
.synthesis{padding:16px;background:#0a0808;border-left:2px solid #6b3030}
.synthesis-title{font-size:10px;color:#cc5500;margin-bottom:12px}
.synthesis-text{font-size:11px;line-height:1.8;color:#999;white-space:pre-wrap}
.copy-btn{font-size:8px;padding:4px 8px;background:#111;border:1px solid #333;color:#555;cursor:pointer;transition:all .2s}
.copy-btn:hover{border-color:#cc5500;color:#cc5500}
.export-bar{position:fixed;bottom:0;left:0;right:0;height:48px;background:#050505;border-top:1px solid #222;display:flex;align-items:center;justify-content:center;gap:16px;padding:0 20px}
.export-btn{font-size:10px;padding:8px 16px;background:#cc5500;border:none;color:#000;cursor:pointer;transition:opacity .2s}
.export-btn:hover{opacity:.8}
.export-btn.secondary{background:none;border:1px solid #333;color:#666}
.export-btn.secondary:hover{border-color:#cc5500;color:#cc5500}
.toast{position:fixed;bottom:68px;left:50%;transform:translateX(-50%);font-size:10px;color:#000;background:#cc5500;padding:8px 16px;opacity:0;transition:all .3s;z-index:200}
.toast.show{opacity:1}
.loading{text-align:center;padding:40px;color:#555}
@media print{
  .header,.export-bar,.drop-zone,.intro,.nav{display:none}
  .container{padding:0;max-width:100%}
  .treatment{break-inside:avoid;border:none;padding:20px 0}
  body{background:#fff;color:#000}
  .treatment-title,.section-title{color:#000}
  .prompt-text,.witness,.synthesis{background:#f5f5f5;border-left-color:#333}
  .witness-text,.prompt-text,.synthesis-text{color:#000}
}
</style>
</head>
<body>
<div class="header">
<div class="logo">THE REPUBLIC / SCRIPT TREATMENTS</div>
<div class="nav">
<button class="nav-btn active" id="btn-all">ALL</button>
<button class="nav-btn" id="btn-multi">MULTI-SOURCE</button>
</div>
</div>
<div class="container">
<div class="intro" id="intro">
<div class="intro-title">SCRIPT TREATMENT GENERATOR</div>
<p>This tool creates unified script treatments for each unique prompt by combining all completions from different sources into a single document.</p>
<p>Each treatment includes: the original prompt (stamped), all witness statements from different sources, and a synthesis section showing common themes.</p>
<p>Use EXPORT to download all treatments as a single document or print directly. Multi-source filter shows only prompts with 2+ completions.</p>
<div class="intro-toggle" id="intro-toggle">[HIDE]</div>
</div>
<div class="stats" id="stats" style="display:none">
<div class="stat"><div class="stat-val" id="s-treatments">0</div><div class="stat-label">Treatments</div></div>
<div class="stat"><div class="stat-val" id="s-sources">0</div><div class="stat-label">Sources</div></div>
<div class="stat"><div class="stat-val" id="s-multi">0</div><div class="stat-label">Multi-Source</div></div>
<div class="stat"><div class="stat-val" id="s-total">0</div><div class="stat-label">Total Witnesses</div></div>
</div>
<div class="toc" id="toc" style="display:none">
<div class="toc-title">TABLE OF CONTENTS</div>
<div id="toc-list"></div>
</div>
<div id="treatments"></div>
</div>
<div class="export-bar">
<button class="export-btn" id="export-json">EXPORT JSON</button>
<button class="export-btn" id="export-txt">EXPORT TXT</button>
<button class="export-btn secondary" id="export-print">PRINT</button>
</div>
<div class="toast" id="toast">COPIED</div>
<script>
const $=s=>document.querySelector(s);
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];
const state={sources:[],cases:new Map(),filter:'all'};

function hash(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i)|0;return'T'+Math.abs(h).toString(16).toUpperCase().slice(0,8)}

function extract(data,fname){
  const pairs=[];
  const title=data.metadata?.title||fname.replace('.json','');
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        let comp='';
        if(data.messages[i+1]?.role==='Response')comp=data.messages[i+1].say||'';
        if(comp)pairs.push({prompt:m.say,comp,key:hash(m.say.trim().replace(/\s+/g,' '))});
      }
    }
  }
  return{fname,title,pairs};
}

function build(){
  state.cases.clear();
  for(const src of state.sources){
    for(const p of src.pairs){
      if(!state.cases.has(p.key))state.cases.set(p.key,{id:p.key,prompt:p.prompt,witnesses:[]});
      state.cases.get(p.key).witnesses.push({source:src.title,fname:src.fname,text:p.comp});
    }
  }
}

function toast(msg){const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
function copyText(txt){navigator.clipboard.writeText(txt).then(()=>toast('COPIED'));}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

function getTitle(prompt){
  const lines=prompt.split('\n').filter(l=>l.trim());
  for(const line of lines.slice(0,5)){
    if(line.includes('REPBUILIC')||line.includes('Republic')||line.length>20)return line.trim().slice(0,80);
  }
  return lines[0]?.trim().slice(0,80)||'Untitled';
}

function generateSynthesis(witnesses){
  if(witnesses.length<2)return'Single source - no synthesis required.';
  const sources=witnesses.map(w=>w.source).join(', ');
  const avgLen=Math.round(witnesses.reduce((a,w)=>a+w.text.length,0)/witnesses.length);
  const themes=[];
  const allText=witnesses.map(w=>w.text.toLowerCase()).join(' ');
  if(allText.includes('republic')||allText.includes('texas'))themes.push('Republic/Texas themes');
  if(allText.includes('plato')||allText.includes('philosophy'))themes.push('Philosophical elements');
  if(allText.includes('mars')||allText.includes('space'))themes.push('Sci-fi setting');
  if(allText.includes('character')||allText.includes('protagonist'))themes.push('Character development');
  if(allText.includes('scene')||allText.includes('act'))themes.push('Dramatic structure');
  return`SOURCES: ${sources}
WITNESS COUNT: ${witnesses.length}
AVG RESPONSE LENGTH: ${avgLen} chars
COMMON THEMES: ${themes.length?themes.join(', '):'Varied approaches'}

This treatment combines ${witnesses.length} different completions for the same prompt, each from a different GPT configuration or session. Compare the variations in tone, detail, and interpretation across sources.`;
}

function renderStats(){
  let total=0;
  state.cases.forEach(c=>total+=c.witnesses.length);
  const multi=[...state.cases.values()].filter(c=>c.witnesses.length>1).length;
  $('#s-treatments').textContent=state.cases.size;
  $('#s-sources').textContent=state.sources.length;
  $('#s-multi').textContent=multi;
  $('#s-total').textContent=total;
  $('#stats').style.display=state.cases.size?'flex':'none';
}

function renderTOC(){
  let html='',i=0;
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    i++;
    const title=getTitle(c.prompt);
    html+=`<a class="toc-item" href="#${k}"><span class="toc-num">${String(i).padStart(2,'0')}</span>${esc(title)} (${c.witnesses.length})</a>`;
  }
  $('#toc-list').innerHTML=html;
  $('#toc').style.display=state.cases.size?'block':'none';
}

function renderTreatments(){
  let html='',i=0;
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    i++;
    const title=getTitle(c.prompt);
    const sources=[...new Set(c.witnesses.map(w=>w.source))];
    
    let witnessHtml='';
    c.witnesses.forEach((w,wi)=>{
      witnessHtml+=`
        <div class="witness">
          <div class="witness-header">
            <span class="witness-source">${esc(w.source)}</span>
            <span class="witness-num">WITNESS ${wi+1} of ${c.witnesses.length}</span>
          </div>
          <div class="witness-text">${esc(w.text)}</div>
        </div>
      `;
    });
    
    html+=`
      <div class="treatment" id="${k}">
        <div class="treatment-header">
          <div class="treatment-id">TREATMENT ${String(i).padStart(3,'0')} / ${k}</div>
          <div class="treatment-title">${esc(title)}</div>
          <div class="treatment-meta">${c.witnesses.length} witness${c.witnesses.length>1?'es':''} from ${sources.length} source${sources.length>1?'s':''}</div>
        </div>
        
        <div class="section">
          <div class="section-title">THE PROMPT (STAMPED)</div>
          <div class="prompt-text">${esc(c.prompt)}</div>
        </div>
        
        <div class="section">
          <div class="section-title">WITNESS STATEMENTS</div>
          ${witnessHtml}
        </div>
        
        <div class="section">
          <div class="section-title">SYNTHESIS</div>
          <div class="synthesis">
            <div class="synthesis-text">${esc(generateSynthesis(c.witnesses))}</div>
          </div>
        </div>
      </div>
    `;
  }
  $('#treatments').innerHTML=html||'<div class="loading">No treatments. Import JSON files.</div>';
}

function render(){
  renderStats();
  renderTOC();
  renderTreatments();
}

function exportJSON(){
  const out={
    exported:new Date().toISOString(),
    title:'THE REPUBLIC - Script Treatments',
    treatments:[]
  };
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    out.treatments.push({
      id:k,
      title:getTitle(c.prompt),
      prompt:c.prompt,
      witnesses:c.witnesses,
      synthesis:generateSynthesis(c.witnesses)
    });
  }
  const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='republic-treatments.json';
  a.click();
  toast('EXPORTED JSON');
}

function exportTXT(){
  let txt='THE REPUBLIC - SCRIPT TREATMENTS\n';
  txt+='Generated: '+new Date().toISOString()+'\n';
  txt+='='.repeat(60)+'\n\n';
  
  let i=0;
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    i++;
    txt+=`TREATMENT ${String(i).padStart(3,'0')} / ${k}\n`;
    txt+='-'.repeat(60)+'\n';
    txt+=`TITLE: ${getTitle(c.prompt)}\n`;
    txt+=`WITNESSES: ${c.witnesses.length}\n\n`;
    
    txt+='THE PROMPT (STAMPED)\n';
    txt+='-'.repeat(40)+'\n';
    txt+=c.prompt+'\n\n';
    
    txt+='WITNESS STATEMENTS\n';
    txt+='-'.repeat(40)+'\n';
    c.witnesses.forEach((w,wi)=>{
      txt+=`\n[WITNESS ${wi+1}] ${w.source}\n`;
      txt+=w.text+'\n';
    });
    
    txt+='\nSYNTHESIS\n';
    txt+='-'.repeat(40)+'\n';
    txt+=generateSynthesis(c.witnesses)+'\n';
    txt+='\n'+'='.repeat(60)+'\n\n';
  }
  
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='republic-treatments.txt';
  a.click();
  toast('EXPORTED TXT');
}

async function autoLoad(){
  $('#treatments').innerHTML='<div class="loading">Loading sources...</div>';
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok)continue;
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.pairs.length)state.sources.push(ex);
    }catch(e){}
  }
  build();render();
}

$('#intro-toggle').onclick=()=>{
  const intro=$('#intro');
  const hidden=intro.style.display==='none';
  intro.style.display=hidden?'block':'none';
  $('#intro-toggle').textContent=hidden?'[HIDE]':'[SHOW]';
};

$('#btn-all').onclick=()=>{
  state.filter='all';
  $('#btn-all').classList.add('active');
  $('#btn-multi').classList.remove('active');
  render();
};

$('#btn-multi').onclick=()=>{
  state.filter='multi';
  $('#btn-multi').classList.add('active');
  $('#btn-all').classList.remove('active');
  render();
};

$('#export-json').onclick=exportJSON;
$('#export-txt').onclick=exportTXT;
$('#export-print').onclick=()=>window.print();

autoLoad();
</script>
</body>
</html>
