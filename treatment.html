<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THE REPUBLIC — Script Treatments</title>
<link rel="icon" type="image/svg+xml" href="favicon-treatment.svg">
<style>
:root{
  --bg:#0a0a0a;--bg2:#111;--panel:#161616;
  --fg:#e8e8e8;--dim:#888;--muted:#555;
  --accent:#d4a853;--orange:#cc5500;
  --prompt:#60a5fa;--witness:#34d399;--synth:#f43f5e;
  --w1:#34d399;--w2:#a78bfa;--w3:#fbbf24;--w4:#f472b6;--w5:#22d3ee;--w6:#fb923c;
  --border:#2a2a2a;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:var(--bg);color:#c4c4c4;font-size:13px;line-height:1.7}

/* Layout */
.app{display:flex;height:100vh;overflow:hidden}

/* Fixed Navigator Sidebar */
.navigator{width:280px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;position:fixed;top:0;left:0;bottom:0;z-index:50}
.nav-header{padding:16px;border-bottom:1px solid var(--border);background:var(--bg)}
.nav-logo{font-size:12px;color:var(--accent);letter-spacing:.1em;font-weight:bold;display:flex;align-items:center;gap:8px;margin-bottom:12px}
.nav-logo svg{width:16px;height:16px}
.nav-progress{height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:10px}
.nav-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--synth));width:0%;transition:width .2s}
.nav-position{font-size:10px;color:var(--muted);display:flex;justify-content:space-between}
.nav-position b{color:var(--fg)}

/* Filter buttons */
.nav-filters{display:flex;gap:4px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg2)}
.filter-btn{flex:1;padding:8px;background:var(--panel);border:1px solid var(--border);color:var(--muted);font:inherit;font-size:9px;cursor:pointer;border-radius:4px;text-transform:uppercase;transition:all .15s}
.filter-btn:hover{border-color:var(--dim);color:var(--dim)}
.filter-btn.active{background:var(--accent);border-color:var(--accent);color:#000}

/* Minimap sections */
.nav-sections{flex:1;overflow-y:auto;padding:8px}
.nav-sections::-webkit-scrollbar{width:4px}
.nav-sections::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

.nav-treatment{margin-bottom:4px;border-radius:6px;overflow:hidden;border:1px solid transparent;transition:all .15s}
.nav-treatment.active{border-color:var(--accent);background:rgba(212,168,83,.05)}
.nav-treatment-header{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s}
.nav-treatment-header:hover{background:rgba(255,255,255,.03)}
.nav-treatment-num{font-size:9px;color:var(--muted);width:24px}
.nav-treatment-title{flex:1;font-size:10px;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.nav-treatment-badge{font-size:8px;padding:2px 5px;background:var(--bg);border:1px solid var(--border);border-radius:3px;color:var(--muted)}
.nav-treatment.active .nav-treatment-title{color:var(--accent)}

/* Sub-sections within treatment */
.nav-subsections{padding:4px 8px 8px 32px;display:none}
.nav-treatment.expanded .nav-subsections{display:block}
.nav-sub{padding:6px 10px;font-size:9px;color:var(--muted);cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:6px;transition:all .15s}
.nav-sub:hover{background:rgba(255,255,255,.03);color:var(--dim)}
.nav-sub.active{color:var(--accent);background:rgba(212,168,83,.05)}
.nav-sub-dot{width:6px;height:6px;border-radius:50%}
.nav-sub[data-type="prompt"] .nav-sub-dot{background:var(--prompt)}
.nav-sub[data-type="witness"] .nav-sub-dot{background:var(--witness)}
.nav-sub[data-type="synth"] .nav-sub-dot{background:var(--synth)}

/* Visual minimap at bottom */
.nav-minimap{height:100px;border-top:1px solid var(--border);position:relative;background:var(--bg)}
.nav-minimap-track{position:absolute;inset:8px;border-radius:4px;overflow:hidden}
.nav-minimap-track canvas{width:100%;height:100%;display:block}
.nav-minimap-viewport{position:absolute;left:8px;right:8px;background:rgba(212,168,83,.15);border:1px solid var(--accent);border-radius:3px;pointer-events:none;box-shadow:0 0 8px rgba(212,168,83,.2)}

/* Main Content Area */
.main{flex:1;margin-left:280px;display:flex;flex-direction:column;overflow:hidden}
.header{height:52px;background:linear-gradient(180deg,#0f0f0f,#080808);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:16px;flex-shrink:0}
.header-stats{display:flex;gap:20px}
.stat{display:flex;align-items:center;gap:6px;font-size:10px}
.stat-val{color:var(--accent);font-weight:bold;font-size:14px}
.stat-label{color:var(--muted);text-transform:uppercase}
.header-actions{margin-left:auto;display:flex;gap:8px}
.btn{padding:8px 14px;background:var(--panel);border:1px solid var(--border);color:var(--dim);font:inherit;font-size:10px;cursor:pointer;border-radius:4px;text-transform:uppercase;transition:all .15s}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#000}
.btn-primary:hover{background:#e8bc6a}

/* Content scroll area */
.content{flex:1;overflow-y:auto;padding:24px 40px 100px;scroll-behavior:smooth}
.content::-webkit-scrollbar{width:10px}
.content::-webkit-scrollbar-track{background:var(--bg2)}
.content::-webkit-scrollbar-thumb{background:var(--border);border-radius:5px;border:2px solid var(--bg2)}
.content::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* Treatment Cards */
.treatment{margin-bottom:48px;padding:24px;background:var(--panel);border:1px solid var(--border);border-radius:8px;scroll-margin-top:20px}
.treatment-header{border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-start}
.treatment-info{flex:1}
.treatment-id{font-size:9px;color:var(--muted);margin-bottom:6px;letter-spacing:.1em}
.treatment-title{font-size:15px;color:var(--accent);line-height:1.4;font-weight:600}
.treatment-meta{font-size:10px;color:var(--muted);margin-top:8px;display:flex;gap:16px}
.treatment-meta span{display:flex;align-items:center;gap:4px}
.treatment-badge{font-size:9px;padding:4px 10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--dim)}

/* Sections */
.section{margin-bottom:24px;scroll-margin-top:80px}
.section-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.section-dot{width:10px;height:10px;border-radius:50%}
.section[data-type="prompt"] .section-dot{background:var(--prompt)}
.section[data-type="witness"] .section-dot{background:var(--witness)}
.section[data-type="synth"] .section-dot{background:var(--synth)}
.section-title{font-size:11px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase}
.section-count{font-size:9px;color:var(--muted);margin-left:auto}

/* Content blocks with line numbers */
.text-block{background:var(--bg);border-radius:6px;overflow:hidden}
.text-block-header{padding:10px 14px;background:rgba(0,0,0,.3);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.text-block-label{font-size:9px;color:var(--muted);letter-spacing:.05em}
.text-block-badge{font-size:8px;padding:2px 6px;background:var(--panel);border:1px solid var(--border);border-radius:3px;color:var(--muted)}
.text-block-content{padding:0}
.text-line{display:flex;padding:3px 0;border-left:2px solid transparent;transition:all .1s}
.text-line:hover{background:rgba(255,255,255,.02);border-left-color:var(--muted)}
.line-num{width:40px;flex-shrink:0;text-align:right;padding-right:14px;font-size:10px;color:var(--muted);user-select:none;opacity:.5}
.line-text{flex:1;color:var(--dim);word-break:break-word;padding-right:14px}

/* Witness cards */
.witness{margin-bottom:16px;border:1px solid var(--border);border-radius:6px;overflow:hidden}
.witness-header{padding:12px 16px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.witness-source{font-size:11px;color:var(--accent);font-weight:600}
.witness-meta{font-size:9px;color:var(--muted)}

/* Synthesis */
.synthesis{background:var(--bg);border-radius:6px;border-left:3px solid var(--synth);padding:16px}
.synthesis-text{font-size:11px;line-height:1.8;color:var(--dim);white-space:pre-wrap}

/* Copy button */
.copy-btn{font-size:8px;padding:4px 8px;background:var(--panel);border:1px solid var(--border);color:var(--muted);cursor:pointer;transition:all .2s;border-radius:3px}
.copy-btn:hover{border-color:var(--accent);color:var(--accent)}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);font-size:11px;color:#000;background:var(--accent);padding:10px 20px;border-radius:4px;opacity:0;transition:all .3s;z-index:200;font-weight:bold}
.toast.show{opacity:1}

.loading{text-align:center;padding:60px;color:var(--muted)}

/* Mobile */
@media(max-width:900px){
  .navigator{width:220px}
  .main{margin-left:220px}
  .content{padding:20px}
}
@media(max-width:768px){
  .navigator{width:60px}
  .nav-header,.nav-filters,.nav-treatment-title,.nav-subsections{display:none}
  .nav-treatment-header{justify-content:center;padding:8px}
  .nav-treatment-num{width:auto}
  .main{margin-left:60px}
  .content{padding:16px}
  .header-stats{display:none}
}
@media(max-width:500px){
  .navigator{display:none}
  .main{margin-left:0}
}

@media print{
  .navigator,.header{display:none}
  .main{margin-left:0}
  .content{padding:0}
  .treatment{break-inside:avoid;border:none;padding:20px 0}
  body{background:#fff;color:#000}
  .treatment-title,.section-title{color:#000}
  .text-block,.witness,.synthesis{background:#f5f5f5}
  .line-text,.synthesis-text{color:#000}
}
</style>
</head>
<body>
<div class="app">
  <aside class="navigator">
    <div class="nav-header">
      <div class="nav-logo">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12,2 15,9 22,9 16.5,14 18.5,21 12,17 5.5,21 7.5,14 2,9 9,9"/></svg>
        TREATMENTS
      </div>
      <div class="nav-progress"><div class="nav-progress-bar" id="progress"></div></div>
      <div class="nav-position">
        <span>Position: <b id="pos-current">0</b> / <b id="pos-total">0</b></span>
        <span id="pos-pct">0%</span>
      </div>
    </div>
    <div class="nav-filters">
      <button class="filter-btn active" id="btn-all">All</button>
      <button class="filter-btn" id="btn-multi">Multi-Source</button>
    </div>
    <div class="nav-sections" id="nav-sections"></div>
    <div class="nav-minimap" id="minimap-wrap">
      <div class="nav-minimap-track"><canvas id="minimap"></canvas></div>
      <div class="nav-minimap-viewport" id="viewport"></div>
    </div>
  </aside>
  <main class="main">
    <header class="header">
      <div class="header-stats">
        <div class="stat"><span class="stat-val" id="s-treatments">0</span><span class="stat-label">Treatments</span></div>
        <div class="stat"><span class="stat-val" id="s-sources">0</span><span class="stat-label">Sources</span></div>
        <div class="stat"><span class="stat-val" id="s-multi">0</span><span class="stat-label">Multi</span></div>
      </div>
      <div class="header-actions">
        <button class="btn" id="export-json">Export JSON</button>
        <button class="btn" id="export-txt">Export TXT</button>
        <button class="btn btn-primary" id="export-print">Print</button>
      </div>
    </header>
    <div class="content" id="content">
      <div class="loading">Loading treatments...</div>
    </div>
  </main>
</div>
<div class="toast" id="toast">COPIED</div>
<script>
const $=s=>document.querySelector(s);
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];
const state={sources:[],cases:new Map(),filter:'all'};

function hash(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i)|0;return'T'+Math.abs(h).toString(16).toUpperCase().slice(0,8)}

function extract(data,fname){
  const pairs=[];
  const title=data.metadata?.title||fname.replace('.json','');
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        let comp='';
        if(data.messages[i+1]?.role==='Response')comp=data.messages[i+1].say||'';
        if(comp)pairs.push({prompt:m.say,comp,key:hash(m.say.trim().replace(/\s+/g,' '))});
      }
    }
  }
  return{fname,title,pairs};
}

function build(){
  state.cases.clear();
  for(const src of state.sources){
    for(const p of src.pairs){
      if(!state.cases.has(p.key))state.cases.set(p.key,{id:p.key,prompt:p.prompt,witnesses:[]});
      state.cases.get(p.key).witnesses.push({source:src.title,fname:src.fname,text:p.comp});
    }
  }
}

function toast(msg){const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
function copyText(txt){navigator.clipboard.writeText(txt).then(()=>toast('COPIED'));}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

function getTitle(prompt){
  const lines=prompt.split('\n').filter(l=>l.trim());
  for(const line of lines.slice(0,5)){
    if(line.includes('REPBUILIC')||line.includes('Republic')||line.length>20)return line.trim().slice(0,80);
  }
  return lines[0]?.trim().slice(0,80)||'Untitled';
}

function generateSynthesis(witnesses){
  if(witnesses.length<2)return'Single source - no synthesis required.';
  const sources=witnesses.map(w=>w.source).join(', ');
  const avgLen=Math.round(witnesses.reduce((a,w)=>a+w.text.length,0)/witnesses.length);
  const themes=[];
  const allText=witnesses.map(w=>w.text.toLowerCase()).join(' ');
  if(allText.includes('republic')||allText.includes('texas'))themes.push('Republic/Texas themes');
  if(allText.includes('plato')||allText.includes('philosophy'))themes.push('Philosophical elements');
  if(allText.includes('mars')||allText.includes('space'))themes.push('Sci-fi setting');
  if(allText.includes('character')||allText.includes('protagonist'))themes.push('Character development');
  if(allText.includes('scene')||allText.includes('act'))themes.push('Dramatic structure');
  return`SOURCES: ${sources}
WITNESS COUNT: ${witnesses.length}
AVG RESPONSE LENGTH: ${avgLen} chars
COMMON THEMES: ${themes.length?themes.join(', '):'Varied approaches'}

This treatment combines ${witnesses.length} different completions for the same prompt, each from a different GPT configuration or session. Compare the variations in tone, detail, and interpretation across sources.`;
}

function formatWithLines(text){
  const lines=text.split('\n');
  let html='';
  lines.forEach((line,i)=>{
    const num=i+1;
    const escaped=esc(line)||'&nbsp;';
    html+=`<div class="text-line"><span class="line-num">${num}</span><span class="line-text">${escaped}</span></div>`;
  });
  return html;
}

function renderStats(){
  let total=0;
  state.cases.forEach(c=>total+=c.witnesses.length);
  const multi=[...state.cases.values()].filter(c=>c.witnesses.length>1).length;
  $('#s-treatments').textContent=state.cases.size;
  $('#s-sources').textContent=state.sources.length;
  $('#s-multi').textContent=multi;
  $('#pos-total').textContent=state.cases.size;
}

function renderNavSections(){
  let html='',i=0;
  state.treatmentIds=[];
  
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    i++;
    state.treatmentIds.push(k);
    const title=getTitle(c.prompt).slice(0,35);
    const multi=c.witnesses.length>1;
    
    html+=`<div class="nav-treatment" data-id="${k}">
      <div class="nav-treatment-header" onclick="toggleTreatment('${k}')">
        <span class="nav-treatment-num">${String(i).padStart(2,'0')}</span>
        <span class="nav-treatment-title">${esc(title)}</span>
        <span class="nav-treatment-badge">${c.witnesses.length}</span>
      </div>
      <div class="nav-subsections">
        <div class="nav-sub" data-type="prompt" onclick="scrollToSection('${k}','prompt')"><span class="nav-sub-dot"></span>Prompt</div>
        ${c.witnesses.map((w,wi)=>`<div class="nav-sub" data-type="witness" onclick="scrollToSection('${k}','w${wi}')"><span class="nav-sub-dot"></span>${esc(w.source.slice(0,20))}</div>`).join('')}
        <div class="nav-sub" data-type="synth" onclick="scrollToSection('${k}','synth')"><span class="nav-sub-dot"></span>Synthesis</div>
      </div>
    </div>`;
  }
  $('#nav-sections').innerHTML=html||'<div style="padding:20px;color:var(--muted);text-align:center">No treatments</div>';
}

function toggleTreatment(id){
  const el=document.querySelector(`.nav-treatment[data-id="${id}"]`);
  if(el){
    document.querySelectorAll('.nav-treatment.expanded').forEach(t=>{
      if(t!==el)t.classList.remove('expanded');
    });
    el.classList.toggle('expanded');
    scrollToTreatment(id);
  }
}

function scrollToTreatment(id){
  const el=document.getElementById(id);
  if(el)el.scrollIntoView({behavior:'smooth',block:'start'});
}

function scrollToSection(treatmentId,sectionId){
  const el=document.getElementById(`${treatmentId}-${sectionId}`);
  if(el)el.scrollIntoView({behavior:'smooth',block:'start'});
}

function renderTreatments(){
  let html='',i=0;
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    i++;
    const title=getTitle(c.prompt);
    const sources=[...new Set(c.witnesses.map(w=>w.source))];
    const lineCount=c.prompt.split('\n').length;
    
    let witnessHtml='';
    c.witnesses.forEach((w,wi)=>{
      const wLines=w.text.split('\n').length;
      const colorIdx=(wi%6)+1;
      witnessHtml+=`
        <div class="witness" id="${k}-w${wi}" style="border-left:3px solid var(--w${colorIdx})">
          <div class="witness-header">
            <span class="witness-source">${esc(w.source)}</span>
            <span class="witness-meta">Witness ${wi+1} of ${c.witnesses.length} • ${wLines} lines</span>
          </div>
          <div class="text-block-content">${formatWithLines(w.text)}</div>
        </div>
      `;
    });
    
    html+=`
      <div class="treatment" id="${k}">
        <div class="treatment-header">
          <div class="treatment-info">
            <div class="treatment-id">TREATMENT ${String(i).padStart(3,'0')} / ${k}</div>
            <div class="treatment-title">${esc(title)}</div>
            <div class="treatment-meta">
              <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>${c.witnesses.length} witness${c.witnesses.length>1?'es':''}</span>
              <span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg>${sources.length} source${sources.length>1?'s':''}</span>
            </div>
          </div>
          <div class="treatment-badge">#${i}</div>
        </div>
        
        <div class="section" data-type="prompt" id="${k}-prompt">
          <div class="section-header">
            <div class="section-dot"></div>
            <div class="section-title">The Prompt (Stamped)</div>
            <div class="section-count">${lineCount} lines</div>
          </div>
          <div class="text-block">
            <div class="text-block-header">
              <span class="text-block-label">STAMPED ${k}</span>
              <button class="copy-btn" onclick="copyText(decodeURIComponent('${encodeURIComponent(c.prompt)}'))">COPY</button>
            </div>
            <div class="text-block-content">${formatWithLines(c.prompt)}</div>
          </div>
        </div>
        
        <div class="section" data-type="witness">
          <div class="section-header">
            <div class="section-dot"></div>
            <div class="section-title">Witness Statements</div>
            <div class="section-count">${c.witnesses.length} responses</div>
          </div>
          ${witnessHtml}
        </div>
        
        <div class="section" data-type="synth" id="${k}-synth">
          <div class="section-header">
            <div class="section-dot"></div>
            <div class="section-title">Synthesis</div>
          </div>
          <div class="synthesis">
            <div class="synthesis-text">${esc(generateSynthesis(c.witnesses))}</div>
          </div>
        </div>
      </div>
    `;
  }
  $('#content').innerHTML=html||'<div class="loading">No treatments loaded.</div>';
}

function render(){
  renderStats();
  renderNavSections();
  renderTreatments();
  renderMinimap();
  updatePosition();
}

function renderMinimap(){
  const canvas=$('#minimap');
  const wrap=$('#minimap-wrap');
  const track=wrap.querySelector('.nav-minimap-track');
  const rect=track.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  
  canvas.width=rect.width*dpr;
  canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  
  const treatments=document.querySelectorAll('.treatment');
  if(!treatments.length)return;
  
  const content=$('#content');
  const contentH=content.scrollHeight;
  const blockH=rect.height/treatments.length;
  
  treatments.forEach((t,i)=>{
    const y=i*blockH;
    const witnesses=t.querySelectorAll('.witness').length;
    
    // Draw treatment bar
    ctx.fillStyle='#333';
    ctx.fillRect(4,y+1,rect.width-8,blockH-2);
    
    // Color by witness count
    const hue=witnesses>1?120:40;
    ctx.fillStyle=`hsl(${hue},50%,40%)`;
    ctx.fillRect(4,y+1,Math.min(witnesses*20,rect.width-8),blockH-2);
  });
}

function updatePosition(){
  const content=$('#content');
  const viewport=$('#viewport');
  const wrap=$('#minimap-wrap');
  const track=wrap.querySelector('.nav-minimap-track');
  const wrapH=track.getBoundingClientRect().height;
  
  const maxScroll=content.scrollHeight-content.clientHeight;
  const scrollRatio=maxScroll>0?content.scrollTop/maxScroll:0;
  const viewRatio=content.clientHeight/content.scrollHeight;
  const pct=Math.round(scrollRatio*100);
  
  // Update viewport indicator
  const h=Math.max(15,wrapH*viewRatio);
  const top=8+scrollRatio*(wrapH-h);
  viewport.style.height=h+'px';
  viewport.style.top=top+'px';
  
  // Update progress bar
  $('#progress').style.width=pct+'%';
  $('#pos-pct').textContent=pct+'%';
  
  // Find current treatment
  const treatments=document.querySelectorAll('.treatment');
  let currentIdx=0;
  treatments.forEach((t,i)=>{
    if(t.getBoundingClientRect().top<100)currentIdx=i+1;
  });
  $('#pos-current').textContent=currentIdx;
  
  // Update active treatment in nav
  if(state.treatmentIds&&state.treatmentIds[currentIdx-1]){
    const activeId=state.treatmentIds[currentIdx-1];
    document.querySelectorAll('.nav-treatment').forEach(t=>{
      t.classList.toggle('active',t.dataset.id===activeId);
    });
  }
}

function exportJSON(){
  const out={
    exported:new Date().toISOString(),
    title:'THE REPUBLIC - Script Treatments',
    treatments:[]
  };
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    out.treatments.push({
      id:k,
      title:getTitle(c.prompt),
      prompt:c.prompt,
      witnesses:c.witnesses,
      synthesis:generateSynthesis(c.witnesses)
    });
  }
  const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='republic-treatments.json';
  a.click();
  toast('EXPORTED JSON');
}

function exportTXT(){
  let txt='THE REPUBLIC - SCRIPT TREATMENTS\n';
  txt+='Generated: '+new Date().toISOString()+'\n';
  txt+='='.repeat(60)+'\n\n';
  
  let i=0;
  for(const[k,c]of state.cases){
    if(state.filter==='multi'&&c.witnesses.length<2)continue;
    i++;
    txt+=`TREATMENT ${String(i).padStart(3,'0')} / ${k}\n`;
    txt+='-'.repeat(60)+'\n';
    txt+=`TITLE: ${getTitle(c.prompt)}\n`;
    txt+=`WITNESSES: ${c.witnesses.length}\n\n`;
    
    txt+='THE PROMPT (STAMPED)\n';
    txt+='-'.repeat(40)+'\n';
    txt+=c.prompt+'\n\n';
    
    txt+='WITNESS STATEMENTS\n';
    txt+='-'.repeat(40)+'\n';
    c.witnesses.forEach((w,wi)=>{
      txt+=`\n[WITNESS ${wi+1}] ${w.source}\n`;
      txt+=w.text+'\n';
    });
    
    txt+='\nSYNTHESIS\n';
    txt+='-'.repeat(40)+'\n';
    txt+=generateSynthesis(c.witnesses)+'\n';
    txt+='\n'+'='.repeat(60)+'\n\n';
  }
  
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='republic-treatments.txt';
  a.click();
  toast('EXPORTED TXT');
}

async function autoLoad(){
  $('#treatments').innerHTML='<div class="loading">Loading sources...</div>';
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok)continue;
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.pairs.length)state.sources.push(ex);
    }catch(e){}
  }
  build();render();
}

$('#btn-all').onclick=()=>{
  state.filter='all';
  $('#btn-all').classList.add('active');
  $('#btn-multi').classList.remove('active');
  render();
};

$('#btn-multi').onclick=()=>{
  state.filter='multi';
  $('#btn-multi').classList.add('active');
  $('#btn-all').classList.remove('active');
  render();
};

$('#export-json').onclick=exportJSON;
$('#export-txt').onclick=exportTXT;
$('#export-print').onclick=()=>window.print();

// Scroll tracking
$('#content').onscroll=updatePosition;

// Minimap click to scroll
$('#minimap-wrap').onclick=e=>{
  const track=e.currentTarget.querySelector('.nav-minimap-track');
  const rect=track.getBoundingClientRect();
  const ratio=(e.clientY-rect.top)/rect.height;
  const content=$('#content');
  content.scrollTo({top:ratio*content.scrollHeight,behavior:'smooth'});
};

// Resize handler
new ResizeObserver(()=>{renderMinimap();updatePosition();}).observe($('#minimap-wrap'));

// Handle hash navigation
if(location.hash){
  setTimeout(()=>{
    const el=document.querySelector(location.hash);
    if(el)el.scrollIntoView({behavior:'smooth'});
  },500);
}

autoLoad();
</script>
</body>
</html>
