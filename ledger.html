<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>THE REPUBLIC â€” EKPHRASTIC LEDGER</title>
<link rel="icon" type="image/svg+xml" href="favicon-ledger.svg">
<style>
:root{
--bg:#0a0a0a;--bg2:#0f0f0f;--bg3:#151515;--panel:#161616;--fg:#e8e8e8;--fg-dim:#a0a0a0;--fg-muted:#606060;--border:#222;
--accent:#cc5500;--accent2:#d8a25a;--mark-ledger:#444;--mark-cases:#cc5500;--mark-prompt:#1f4e7a;--mark-witness:#2d5a3d;--mark-compare:#6b3030;
--col-w:320px;--col-collapsed:36px;--unit-hover:#161616;--unit-active:#1a1a1a;
--ease:cubic-bezier(.4,0,.2,1);--scanline:rgba(0,0,0,.03)
}
[data-theme="light"]{--bg:#f5f0e6;--bg2:#ebe5d8;--bg3:#e0dbd0;--panel:#fff;--fg:#1a1a1a;--fg-dim:#4a4a4a;--fg-muted:#888;--border:#d5d0c0;--accent:#8b4513;--accent2:#a67c52;--mark-ledger:#c0b8a0;--mark-cases:#8b4513;--mark-prompt:#4a4a6a;--mark-witness:#3a5a3a;--mark-compare:#6a3a3a;--unit-hover:#efe8da;--unit-active:#e8e0d0;--scanline:rgba(0,0,0,.01)}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Courier New',monospace;font-size:11px;background:var(--bg);color:var(--fg);transition:background .3s,color .3s}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,var(--scanline) 2px,var(--scanline) 4px);pointer-events:none;z-index:9999}
.scroll-container{display:flex;height:100%;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
.scroll-container::-webkit-scrollbar{height:6px}
.scroll-container::-webkit-scrollbar-track{background:var(--bg)}
.scroll-container::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.scroll-container::-webkit-scrollbar-thumb:hover{background:var(--fg2)}
.column{flex-shrink:0;width:var(--col-w);height:100%;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg);transition:width .2s var(--ease);position:relative;overflow:hidden}
.column.collapsed{width:var(--col-collapsed)}
.column.collapsed .column-header,.column.collapsed .column-content{opacity:0;pointer-events:none}
.column.collapsed .column-tab{opacity:1;pointer-events:auto}
.column-tab{position:absolute;top:0;left:0;width:var(--col-collapsed);height:100%;writing-mode:vertical-rl;text-orientation:mixed;display:flex;align-items:center;justify-content:center;font-size:8px;letter-spacing:1px;color:var(--fg-muted);cursor:pointer;opacity:0;transition:opacity .2s;text-transform:uppercase;background:var(--bg2)}
.column-tab:hover{color:var(--fg)}
.column-header{padding:12px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;align-items:flex-start;gap:8px;min-height:48px}
.column-marker{width:8px;height:8px;flex-shrink:0;margin-top:3px}
.column-marker.ledger{background:var(--mark-ledger)}
.column-marker.cases{background:var(--mark-cases)}
.column-marker.prompt{background:var(--mark-prompt)}
.column-marker.witness{background:var(--mark-witness)}
.column-marker.compare{background:var(--mark-compare)}
.column-title{font-size:9px;letter-spacing:.5px;text-transform:uppercase;color:var(--fg-dim)}
.column-title span{display:block;font-size:8px;margin-top:3px;color:var(--fg-muted)}
.column-content{flex:1;overflow-y:auto;padding:12px}
.column-content::-webkit-scrollbar{width:4px}
.column-content::-webkit-scrollbar-track{background:transparent}
.column-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.unit{padding:12px;margin-bottom:8px;border-left:2px solid var(--border);background:var(--bg);cursor:pointer;transition:all .15s var(--ease)}
.unit:hover{background:var(--unit-hover);border-left-color:var(--fg2)}
.unit.active{background:var(--unit-active);border-left-color:var(--accent)}
.unit.selected{border-left-color:var(--accent);box-shadow:inset 0 0 0 1px var(--border)}
.unit-id{font-size:9px;color:var(--fg2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.unit-title{font-size:11px;line-height:1.5;color:var(--fg);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.unit-meta{font-size:9px;color:var(--fg2);margin-top:6px}
.unit-text{font-size:11px;line-height:1.6;white-space:pre-wrap;word-break:break-word;color:var(--fg)}
.unit-text.full{max-height:none}
.stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:10px}
.stat-row:last-child{border-bottom:none}
.stat-label{color:var(--fg2)}
.stat-value{color:var(--accent)}
.file-item{padding:8px 0;border-bottom:1px solid var(--border);font-size:10px;color:var(--fg2)}
.file-item:last-child{border-bottom:none}
.drop-zone{border:1px dashed var(--border);padding:20px;text-align:center;margin-bottom:12px;cursor:pointer;transition:border-color .2s}
.drop-zone:hover,.drop-zone.over{border-color:var(--accent)}
.drop-zone-text{font-size:10px;color:var(--fg2)}
.compare-block{margin-bottom:16px;padding:12px;border-left:2px solid var(--mark-compare);background:var(--bg2)}
.compare-block h4{font-size:9px;color:var(--fg2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;font-weight:normal}
.compare-block pre{font-size:10px;line-height:1.5;white-space:pre-wrap;word-break:break-word;color:var(--fg);max-height:400px;overflow-y:auto}
.toast{position:fixed;top:16px;right:16px;font-size:10px;color:var(--accent);opacity:0;transition:opacity .2s;z-index:1000;text-transform:uppercase;letter-spacing:1px}
.toast.show{opacity:1}
.theme-label{font-size:8px;color:var(--fg2);opacity:.5;margin-top:8px}
input[type="file"]{display:none}
.empty{padding:20px;text-align:center;color:var(--fg2);font-size:10px}
.breadcrumb{position:fixed;top:0;left:0;right:0;height:36px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;font-size:9px;color:var(--fg-muted);z-index:100;gap:6px}
.breadcrumb-item{color:var(--fg2);cursor:pointer;transition:color .2s}
.breadcrumb-item:hover{color:var(--fg)}
.breadcrumb-item.active{color:var(--accent)}
.breadcrumb-sep{color:var(--border)}
.intro{padding:16px;margin-bottom:12px;border:1px solid var(--border);background:var(--bg2);font-size:10px;line-height:1.8;color:var(--fg2)}
.intro-title{font-size:11px;color:var(--accent);margin-bottom:10px;letter-spacing:.1em}
.intro p{margin-bottom:6px}
.intro-toggle{font-size:9px;color:var(--fg2);cursor:pointer;margin-top:8px;opacity:.6}
.intro-toggle:hover{opacity:1}
.copy-btn{position:absolute;top:8px;right:8px;font-size:8px;padding:4px 8px;background:var(--bg);border:1px solid var(--border);color:var(--fg2);cursor:pointer;opacity:0;transition:all .2s}
.unit:hover .copy-btn{opacity:1}
.copy-btn:hover{border-color:var(--accent);color:var(--accent)}
.help{position:fixed;bottom:8px;right:16px;font-size:9px;color:var(--fg2);opacity:.5}
@media(min-width:768px){:root{--col-w:400px}}
@media(max-width:480px){:root{--col-w:calc(100vw - 48px)}}
</style>
</head>
<body data-theme="sunset">
<div class="breadcrumb" id="breadcrumb">
<span class="breadcrumb-item active">THE REPUBLIC</span>
<span class="breadcrumb-sep">/</span>
<span class="breadcrumb-item" id="bc-level">EKPHRASTIC LEDGER</span>
</div>
<div class="scroll-container" id="scroll" style="height:calc(100% - 32px);margin-top:32px">
<div class="column" id="col-ledger" data-type="ledger">
<div class="column-tab">LEDGER</div>
<div class="column-header">
<div class="column-marker ledger"></div>
<div class="column-title">LEDGER<span id="theme-display">THEME: SUNSET</span></div>
</div>
<div class="column-content">
<div class="intro" id="intro">
<div class="intro-title">THE REPUBLIC / EKPHRASTIC LEDGER</div>
<p>A prompt/completion analysis tool that imports JSON files, extracts prompt-response pairs, and groups identical prompts across sources for comparison.</p>
<p>FLOW: LEDGER shows sources and stats. CASES lists grouped prompts. Click a case to see PROMPT and WITNESS columns. Select 2-3 witnesses to open CROSS-EXAMINATION.</p>
<p>CONTROLS: T cycles themes. C copies selected text. Double-click or long-press to copy. H toggles this help. Arrow keys scroll.</p>
<div class="intro-toggle" id="intro-toggle">[HIDE]</div>
</div>
<div class="drop-zone" id="drop">
<div class="drop-zone-text">DROP JSON FILES HERE OR CLICK</div>
<input type="file" id="files" multiple accept=".json">
</div>
<div id="file-list"></div>
<div id="census"></div>
</div>
</div>
<div class="column" id="col-cases" data-type="cases">
<div class="column-tab">CASES</div>
<div class="column-header">
<div class="column-marker cases"></div>
<div class="column-title">CASES<span id="case-count">0 records</span></div>
</div>
<div class="column-content" id="cases-content"></div>
</div>
</div>
<div class="toast" id="toast">COPIED</div>
<div class="help">KEYS: T theme / C copy / H help / ARROWS scroll</div>
<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const THEMES=['sunset','phosphor','bluesteel','ledger'];
const THEME_NAMES={sunset:'SUNSET',phosphor:'PHOSPHOR',bluesteel:'BLUE STEEL',ledger:'LEDGER'};
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];

const state={
  sources:[],
  cases:new Map(),
  activeCase:null,
  activeUnit:null,
  selected:new Set(),
  theme:localStorage.getItem('theme')||'sunset'
};

function hash(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i)|0;return'C'+Math.abs(h).toString(16).toUpperCase().slice(0,8)}

function extract(data,fname){
  const pairs=[];
  const title=data.metadata?.title||fname;
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        let comp='';
        if(data.messages[i+1]?.role==='Response')comp=data.messages[i+1].say||'';
        if(comp)pairs.push({prompt:m.say,comp,key:hash(m.say.trim().replace(/\s+/g,' '))});
      }
    }
  }
  if(Array.isArray(data)){
    for(const r of data){
      const p=r.prompt||r.input||r.request?.prompt||(r.messages?r.messages.map(m=>`${m.role||'USER'}:${m.content}`).join('\n'):'');
      const c=r.completion||r.response||r.output||r.choices?.[0]?.message?.content||r.choices?.[0]?.text||'';
      if(p&&c)pairs.push({prompt:p,comp:c,key:hash(p.trim().replace(/\s+/g,' '))});
    }
  }
  return{fname,title,pairs};
}

function build(){
  state.cases.clear();
  for(const src of state.sources){
    for(const p of src.pairs){
      if(!state.cases.has(p.key))state.cases.set(p.key,{id:p.key,prompt:p.prompt,comps:[]});
      state.cases.get(p.key).comps.push({src:src.title,fname:src.fname,text:p.comp});
    }
  }
}

function setTheme(t){
  state.theme=t;
  document.body.dataset.theme=t;
  localStorage.setItem('theme',t);
  $('#theme-display').textContent='THEME: '+THEME_NAMES[t];
}

function cycleTheme(){
  const i=(THEMES.indexOf(state.theme)+1)%THEMES.length;
  setTheme(THEMES[i]);
}

function toast(msg){
  const t=$('#toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1200);
}

function copyText(txt){
  navigator.clipboard.writeText(txt).then(()=>toast('COPIED'));
}

function removeColumnsAfter(type){
  const order=['ledger','cases','prompt','witness','compare'];
  const idx=order.indexOf(type);
  $$('.column').forEach(col=>{
    const t=col.dataset.type;
    if(order.indexOf(t)>idx)col.remove();
  });
}

function addColumn(type,title,subtitle,content){
  removeColumnsAfter({ledger:'ledger',cases:'cases',prompt:'prompt',witness:'witness',compare:'compare'}[type]||type);
  const prev=type==='prompt'?'cases':type==='witness'?'prompt':type==='compare'?'witness':null;
  if(prev)removeColumnsAfter(prev);
  
  const col=document.createElement('div');
  col.className='column';
  col.dataset.type=type;
  col.innerHTML=`
    <div class="column-tab">${title}</div>
    <div class="column-header">
      <div class="column-marker ${type}"></div>
      <div class="column-title">${title}<span>${subtitle}</span></div>
    </div>
    <div class="column-content">${content}</div>
  `;
  col.querySelector('.column-tab').onclick=()=>col.classList.toggle('collapsed');
  $('#scroll').appendChild(col);
  setTimeout(()=>col.scrollIntoView({behavior:'smooth',inline:'start'}),50);
  return col;
}

function renderFiles(){
  $('#file-list').innerHTML=state.sources.map(s=>`<div class="file-item">${s.fname} (${s.pairs.length})</div>`).join('')||'';
}

function renderCensus(){
  let total=0;
  state.cases.forEach(c=>total+=c.comps.length);
  const multi=[...state.cases.values()].filter(c=>c.comps.length>1).length;
  $('#census').innerHTML=`
    <div class="stat-row"><span class="stat-label">SOURCES</span><span class="stat-value">${state.sources.length}</span></div>
    <div class="stat-row"><span class="stat-label">TOTAL RECORDS</span><span class="stat-value">${total}</span></div>
    <div class="stat-row"><span class="stat-label">UNIQUE CASES</span><span class="stat-value">${state.cases.size}</span></div>
    <div class="stat-row"><span class="stat-label">MULTI-WITNESS</span><span class="stat-value">${multi}</span></div>
  `;
}

function renderCases(){
  let html='',i=0;
  for(const[k,c]of state.cases){
    i++;
    const title=c.prompt.split('\n').find(l=>l.trim())||'Untitled';
    const srcs=[...new Set(c.comps.map(x=>x.src))].length;
    html+=`<div class="unit ${state.activeCase===k?'active':''}" data-key="${k}">
      <div class="unit-id">CASE ${String(i).padStart(3,'0')}</div>
      <div class="unit-title">${esc(title.slice(0,120))}</div>
      <div class="unit-meta">${c.comps.length} witness${c.comps.length>1?'es':''} / ${srcs} source${srcs>1?'s':''}</div>
    </div>`;
  }
  $('#cases-content').innerHTML=html||'<div class="empty">NO CASES</div>';
  $('#case-count').textContent=state.cases.size+' records';
  $$('#cases-content .unit').forEach(u=>{
    u.onclick=()=>openCase(u.dataset.key);
    u.ondblclick=()=>{const c=state.cases.get(u.dataset.key);if(c)copyText(c.prompt);};
  });
}

function openCase(key){
  const c=state.cases.get(key);
  if(!c)return;
  state.activeCase=key;
  state.selected.clear();
  renderCases();
  updateBreadcrumb();
  
  const promptHtml=`<div class="unit active" data-type="prompt"><div class="unit-id">STAMPED ${key}</div><div class="unit-text full">${esc(c.prompt)}</div></div>`;
  const promptCol=addColumn('prompt','PROMPT (STAMPED)','full text',promptHtml);
  promptCol.querySelector('.unit').ondblclick=()=>copyText(c.prompt);
  
  let witnessHtml='';
  c.comps.forEach((w,i)=>{
    witnessHtml+=`<div class="unit ${state.selected.has(i)?'selected':''}" data-idx="${i}">
      <div class="unit-id">${esc(w.src)}</div>
      <div class="unit-text">${esc(w.text.slice(0,500))}${w.text.length>500?'...':''}</div>
    </div>`;
  });
  const witnessCol=addColumn('witness','WITNESS STATEMENTS',c.comps.length+' responses',witnessHtml);
  witnessCol.querySelectorAll('.unit').forEach(u=>{
    u.onclick=()=>toggleWitness(key,+u.dataset.idx);
    u.ondblclick=()=>{const w=c.comps[+u.dataset.idx];if(w)copyText(w.text);};
  });
}

function toggleWitness(caseKey,idx){
  if(state.selected.has(idx)){
    state.selected.delete(idx);
  }else{
    if(state.selected.size>=3){toast('MAX 3');return;}
    state.selected.add(idx);
  }
  state.activeUnit={caseKey,idx};
  updateWitnessSelection();
  updateCompare();
}

function updateWitnessSelection(){
  $$('#scroll .column[data-type="witness"] .unit').forEach(u=>{
    u.classList.toggle('selected',state.selected.has(+u.dataset.idx));
  });
}

function updateCompare(){
  const existingCompare=$('.column[data-type="compare"]');
  if(state.selected.size<2){
    if(existingCompare)existingCompare.remove();
    return;
  }
  const c=state.cases.get(state.activeCase);
  if(!c)return;
  
  let html='';
  for(const idx of state.selected){
    const w=c.comps[idx];
    if(w){
      html+=`<div class="compare-block"><h4>${esc(w.src)}</h4><pre>${esc(w.text)}</pre></div>`;
    }
  }
  
  if(existingCompare){
    existingCompare.querySelector('.column-content').innerHTML=html;
    existingCompare.querySelector('.column-title span').textContent=state.selected.size+' compared';
  }else{
    addColumn('compare','CROSS-EXAMINATION',state.selected.size+' compared',html);
  }
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

async function loadFile(f){
  try{
    const txt=await f.text();
    const data=JSON.parse(txt);
    if(state.sources.find(s=>s.fname===f.name))return;
    const ex=extract(data,f.name);
    if(ex.pairs.length)state.sources.push(ex);
  }catch(e){console.error(e);}
}

async function autoLoad(){
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok)continue;
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.pairs.length)state.sources.push(ex);
    }catch(e){}
  }
  build();renderFiles();renderCensus();renderCases();
}

// Events
$('#drop').onclick=()=>$('#files').click();
$('#drop').ondragover=e=>{e.preventDefault();$('#drop').classList.add('over');};
$('#drop').ondragleave=()=>$('#drop').classList.remove('over');
$('#drop').ondrop=async e=>{
  e.preventDefault();$('#drop').classList.remove('over');
  for(const f of e.dataTransfer.files)await loadFile(f);
  build();renderFiles();renderCensus();renderCases();
};
$('#files').onchange=async e=>{
  for(const f of e.target.files)await loadFile(f);
  build();renderFiles();renderCensus();renderCases();
};

document.body.ondragover=e=>e.preventDefault();
document.body.ondrop=async e=>{
  e.preventDefault();
  for(const f of e.dataTransfer.files)if(f.name.endsWith('.json'))await loadFile(f);
  build();renderFiles();renderCensus();renderCases();
};

$$('.column-tab').forEach(tab=>tab.onclick=()=>tab.closest('.column').classList.toggle('collapsed'));

// Intro toggle
$('#intro-toggle').onclick=()=>{
  const intro=$('#intro');
  const hidden=intro.style.display==='none';
  intro.style.display=hidden?'block':'none';
  $('#intro-toggle').textContent=hidden?'[HIDE]':'[SHOW]';
};

// Breadcrumb update
function updateBreadcrumb(){
  const parts=['EKPHRASTIC LEDGER'];
  if(state.activeCase){
    const c=state.cases.get(state.activeCase);
    if(c){const t=c.prompt.split('\n')[0]||'CASE';parts.push(t.slice(0,30)+(t.length>30?'...':''));}
  }
  $('#bc-level').textContent=parts.join(' / ');
}

document.onkeydown=e=>{
  if(e.key==='t'&&!e.ctrlKey&&!e.metaKey){cycleTheme();e.preventDefault();}
  if(e.key==='h'&&!e.ctrlKey&&!e.metaKey){$('#intro-toggle').click();e.preventDefault();}
  if(e.key==='c'&&!e.ctrlKey&&!e.metaKey&&state.activeUnit){
    const c=state.cases.get(state.activeUnit.caseKey);
    if(c&&c.comps[state.activeUnit.idx])copyText(c.comps[state.activeUnit.idx].text);
  }
  if(e.key==='ArrowRight'){$('#scroll').scrollBy({left:300,behavior:'smooth'});}
  if(e.key==='ArrowLeft'){$('#scroll').scrollBy({left:-300,behavior:'smooth'});}
};

// Long press for mobile copy
let pressTimer;
document.addEventListener('touchstart',e=>{
  const unit=e.target.closest('.unit');
  if(!unit)return;
  pressTimer=setTimeout(()=>{
    const type=unit.closest('.column')?.dataset.type;
    if(type==='prompt'&&state.activeCase){
      copyText(state.cases.get(state.activeCase).prompt);
    }else if(type==='witness'&&state.activeCase){
      const idx=+unit.dataset.idx;
      const c=state.cases.get(state.activeCase);
      if(c?.comps[idx])copyText(c.comps[idx].text);
    }else if(type==='cases'){
      const c=state.cases.get(unit.dataset.key);
      if(c)copyText(c.prompt);
    }
  },600);
});
document.addEventListener('touchend',()=>clearTimeout(pressTimer));
document.addEventListener('touchmove',()=>clearTimeout(pressTimer));

// Init
setTheme(state.theme);
autoLoad();
</script>
</body>
</html>
