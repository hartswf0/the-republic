<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THE REPUBLIC — Comparison Reader</title>
<link rel="icon" type="image/svg+xml" href="favicon-compare.svg">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:#000;color:#ccc;overflow:hidden;font-size:13px;line-height:1.7}
.breadcrumb{position:fixed;top:0;left:0;right:0;height:32px;background:#0a0a0a;border-bottom:1px solid #222;display:flex;align-items:center;padding:0 16px;font-size:10px;color:#555;z-index:100;gap:8px}
.breadcrumb-item{color:#666;cursor:pointer;transition:color .2s}
.breadcrumb-item:hover{color:#999}
.breadcrumb-item.active{color:#cc5500}
.breadcrumb-sep{color:#333}
.scroll-container{display:flex;height:calc(100vh - 32px);margin-top:32px;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth}
.column{min-width:400px;width:400px;height:100vh;border-right:1px solid #222;background:#000;display:flex;flex-direction:column;flex-shrink:0;transition:all .4s cubic-bezier(.4,0,.2,1);position:relative}
.column.collapsed{min-width:48px;width:48px}
.column-tab{writing-mode:vertical-rl;text-orientation:mixed;padding:20px 0;background:#0a0a0a;cursor:pointer;text-align:center;font-size:11px;letter-spacing:.2em;color:#666;transition:all .2s;user-select:none;position:absolute;top:0;left:0;width:48px;height:100%;z-index:10;opacity:0}
.column.collapsed .column-tab{opacity:1}
.column-tab:hover{background:#1a1a1a;color:#999}
.column-header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid #222;background:#0a0a0a;flex-shrink:0}
.column.collapsed .column-header{opacity:0;pointer-events:none}
.column-title{font-size:10px;letter-spacing:.15em;color:#666}
.column-subtitle{font-size:9px;color:#444;margin-top:4px}
.column-marker{width:6px;height:6px;background:#666}
.column[data-type="cases"] .column-marker{background:#cc5500}
.column[data-type="prompt"] .column-marker{background:#4466aa}
.column[data-type="witness"] .column-marker{background:#44aa66}
.column-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:24px;opacity:1;transition:opacity .3s}
.column.collapsed .column-content{opacity:0;pointer-events:none}
.unit{margin-bottom:24px;padding:20px;background:#0a0a0a;border-left:2px solid transparent;cursor:pointer;transition:all .2s;position:relative}
.unit:hover{background:#111;padding-left:24px}
.unit.active{background:#111;border-left-color:#fff;padding-left:24px}
.column[data-type="cases"] .unit.active{border-left-color:#cc5500}
.column[data-type="prompt"] .unit.active{border-left-color:#4466aa}
.column[data-type="witness"] .unit.active{border-left-color:#44aa66}
.unit-id{font-size:9px;color:#444;margin-bottom:8px;letter-spacing:.1em}
.unit-text{color:#888;line-height:1.8}
.unit.active .unit-text{color:#bbb}
.unit-meta{font-size:9px;color:#555;margin-top:10px}
.origin-marker{position:absolute;top:12px;right:12px;font-size:8px;color:#333;background:#000;padding:4px 8px;border:1px solid #1a1a1a;letter-spacing:.1em}
.collapse-hint{position:absolute;top:50%;right:8px;transform:translateY(-50%);font-size:16px;color:#333;cursor:pointer;user-select:none;transition:color .2s;z-index:5}
.collapse-hint:hover{color:#666}
.column.collapsed .collapse-hint{display:none}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.column.new{animation:slideIn .4s ease-out}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:#000}
::-webkit-scrollbar-thumb{background:#222}
::-webkit-scrollbar-thumb:hover{background:#333}
.drop-zone{border:1px dashed #333;padding:20px;text-align:center;margin-bottom:20px;cursor:pointer;transition:all .2s;font-size:10px;color:#555}
.drop-zone:hover,.drop-zone.over{border-color:#cc5500;color:#888}
.intro{padding:20px;margin-bottom:20px;border:1px solid #1a1a1a;background:#050505;font-size:10px;line-height:1.8;color:#666}
.intro-title{font-size:11px;color:#cc5500;margin-bottom:12px;letter-spacing:.1em}
.intro p{margin-bottom:8px}
.intro-toggle{font-size:9px;color:#444;cursor:pointer;margin-top:8px}
.intro-toggle:hover{color:#888}
.line{padding:4px 8px;margin:2px 0;cursor:pointer;transition:all .15s;border-left:2px solid transparent}
.line:hover{background:#111;border-left-color:#333}
.line.selected{background:#1a1a1a;border-left-color:#cc5500}
.copy-btn{position:absolute;top:8px;right:8px;font-size:8px;padding:4px 8px;background:#111;border:1px solid #333;color:#555;cursor:pointer;opacity:0;transition:all .2s}
.unit:hover .copy-btn{opacity:1}
.copy-btn:hover{border-color:#cc5500;color:#cc5500}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);font-size:10px;color:#000;background:#cc5500;padding:8px 16px;opacity:0;transition:all .3s;z-index:200}
.toast.show{opacity:1}
.help{position:fixed;bottom:8px;right:16px;font-size:9px;color:#333}
.stat{padding:12px 0;border-bottom:1px solid #1a1a1a;display:flex;justify-content:space-between;font-size:10px}
.stat-label{color:#555}
.stat-value{color:#cc5500}
.witness-text{font-size:12px;line-height:1.8;color:#999;white-space:pre-wrap;word-break:break-word}
.prompt-full{font-size:11px;line-height:1.8;color:#888;white-space:pre-wrap;word-break:break-word;max-height:none}
input[type="file"]{display:none}
@media(max-width:600px){.column{min-width:320px;width:320px}.column.collapsed{min-width:40px;width:40px}.column-tab{width:40px}}
</style>
</head>
<body>
<div class="breadcrumb" id="breadcrumb">
<span class="breadcrumb-item active">THE REPUBLIC</span>
<span class="breadcrumb-sep">/</span>
<span class="breadcrumb-item" id="bc-level">COMPARISON READER</span>
</div>
<div class="scroll-container" id="scroll">
<div class="column" data-type="cases" data-index="0">
<div class="column-tab">CASES</div>
<div class="column-header">
<div class="column-title">CASES<div class="column-subtitle" id="case-count">loading...</div></div>
<div class="column-marker"></div>
</div>
<div class="collapse-hint">&lt;</div>
<div class="column-content">
<div class="intro" id="intro">
<div class="intro-title">THE REPUBLIC / COMPARISON READER</div>
<p>A tool for analyzing prompt/completion pairs across multiple JSON sources. When the same prompt appears in different files, this reader displays all completions side-by-side in horizontal columns for direct comparison.</p>
<p>WORKFLOW: Select a case from the left column. The prompt text appears, followed by one column per source file containing that prompt. Scroll horizontally to compare responses. Collapse columns to tabs using the left arrow.</p>
<p>CONTROLS: Click any text block to select it. Double-click or press C to copy selected text. Press H to toggle this help.</p>
<div class="intro-toggle" id="intro-toggle">[HIDE INTRO]</div>
</div>
<div class="drop-zone" id="drop">DROP JSON FILES HERE OR CLICK TO SELECT<input type="file" id="files" multiple accept=".json"></div>
<div id="stats"></div>
<div id="cases"></div>
</div>
</div>
</div>
<div class="toast" id="toast">COPIED</div>
<div class="help">KEYS: C copy / H help / LEFT/RIGHT scroll</div>
<script>
const $=s=>document.querySelector(s);
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];
const state={sources:[],cases:new Map(),activeCase:null,colIndex:0,selectedText:'',selectedUnit:null};

function toast(msg){const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1200);}
function copyText(txt){if(!txt)return;navigator.clipboard.writeText(txt).then(()=>toast('COPIED'));}
function updateBreadcrumb(){
  const parts=['COMPARISON READER'];
  if(state.activeCase){
    const c=state.cases.get(state.activeCase);
    if(c){const t=c.prompt.split('\n')[0]||'CASE';parts.push(t.slice(0,40)+(t.length>40?'...':''));}
  }
  $('#bc-level').textContent=parts.join(' / ');
}

function hash(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i)|0;return'C'+Math.abs(h).toString(16).toUpperCase().slice(0,8)}

function extract(data,fname){
  const pairs=[];
  const title=data.metadata?.title||fname.replace('.json','');
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        let comp='';
        if(data.messages[i+1]?.role==='Response')comp=data.messages[i+1].say||'';
        if(comp)pairs.push({prompt:m.say,comp,key:hash(m.say.trim().replace(/\s+/g,' '))});
      }
    }
  }
  return{fname,title,pairs};
}

function build(){
  state.cases.clear();
  for(const src of state.sources){
    for(const p of src.pairs){
      if(!state.cases.has(p.key))state.cases.set(p.key,{id:p.key,prompt:p.prompt,witnesses:[]});
      state.cases.get(p.key).witnesses.push({source:src.title,fname:src.fname,text:p.comp});
    }
  }
}

function renderStats(){
  let total=0;
  state.cases.forEach(c=>total+=c.witnesses.length);
  const multi=[...state.cases.values()].filter(c=>c.witnesses.length>1).length;
  $('#stats').innerHTML=`
    <div class="stat"><span class="stat-label">SOURCES</span><span class="stat-value">${state.sources.length}</span></div>
    <div class="stat"><span class="stat-label">CASES</span><span class="stat-value">${state.cases.size}</span></div>
    <div class="stat"><span class="stat-label">MULTI-WITNESS</span><span class="stat-value">${multi}</span></div>
  `;
  $('#case-count').textContent=state.cases.size+' grouped prompts';
}

function renderCases(){
  let html='',i=0;
  for(const[k,c]of state.cases){
    i++;
    const title=c.prompt.split('\n').find(l=>l.trim())||'Untitled';
    const sources=c.witnesses.map(w=>w.source.slice(0,12)).join(', ');
    html+=`<div class="unit" data-id="${k}">
      <div class="unit-id">CASE ${String(i).padStart(3,'0')}</div>
      <div class="unit-text">${esc(title.slice(0,150))}</div>
      <div class="unit-meta">${c.witnesses.length} witness${c.witnesses.length>1?'es':''} — ${sources}</div>
    </div>`;
  }
  $('#cases').innerHTML=html||'<div style="color:#444;padding:20px;text-align:center">No cases loaded</div>';
  document.querySelectorAll('#cases .unit').forEach(u=>{
    u.onclick=()=>selectCase(u.dataset.id);
  });
}

function selectCase(id){
  state.activeCase=id;
  state.selectedText='';
  state.selectedUnit=null;
  document.querySelectorAll('[data-type="cases"] .unit').forEach(u=>u.classList.remove('active'));
  const unit=document.querySelector(`[data-type="cases"] [data-id="${id}"]`);
  if(unit)unit.classList.add('active');
  
  const c=state.cases.get(id);
  if(!c)return;
  
  removeColumnsAfter('cases');
  updateBreadcrumb();
  
  // Add prompt column
  addColumn('prompt','PROMPT (STAMPED)',c.id,`
    <div class="unit" data-text="${encodeURIComponent(c.prompt)}">
      <button class="copy-btn" data-copy="prompt">COPY</button>
      <div class="unit-id">STAMPED ${c.id}</div>
      <div class="prompt-full">${esc(c.prompt)}</div>
    </div>
  `);
  
  // Add one column per witness (source)
  c.witnesses.forEach((w,i)=>{
    addColumn('witness',w.source,`WITNESS ${i+1} of ${c.witnesses.length}`,`
      <div class="unit" data-text="${encodeURIComponent(w.text)}" data-idx="${i}">
        <button class="copy-btn" data-copy="witness">COPY</button>
        <div class="unit-id">SOURCE: ${esc(w.fname)}</div>
        <div class="witness-text">${esc(w.text)}</div>
      </div>
    `);
  });
  
  // Bind copy buttons and selection
  document.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const unit=btn.closest('.unit');
      const txt=decodeURIComponent(unit.dataset.text||'');
      copyText(txt);
    };
  });
  document.querySelectorAll('.column[data-type="prompt"] .unit, .column[data-type="witness"] .unit').forEach(u=>{
    u.onclick=()=>selectUnit(u);
    u.ondblclick=()=>{const txt=decodeURIComponent(u.dataset.text||'');copyText(txt);};
  });
}

function addColumn(type,title,subtitle,content){
  state.colIndex++;
  const col=document.createElement('div');
  col.className='column new';
  col.dataset.type=type;
  col.dataset.index=state.colIndex;
  col.innerHTML=`
    <div class="column-tab">${title.slice(0,15).toUpperCase()}</div>
    <div class="column-header">
      <div class="column-title">${title.toUpperCase()}<div class="column-subtitle">${subtitle}</div></div>
      <div class="column-marker"></div>
    </div>
    <div class="collapse-hint">‹</div>
    <div class="column-content">${content}</div>
  `;
  const hint=col.querySelector('.collapse-hint');
  const tab=col.querySelector('.column-tab');
  hint.onclick=()=>col.classList.toggle('collapsed');
  tab.onclick=()=>col.classList.toggle('collapsed');
  $('#scroll').appendChild(col);
  setTimeout(()=>{
    col.classList.remove('new');
    $('#scroll').scrollLeft=$('#scroll').scrollWidth;
  },50);
}

function removeColumnsAfter(type){
  document.querySelectorAll('.column').forEach(col=>{
    if(col.dataset.type!=='cases'&&col.dataset.type!==type)col.remove();
  });
}

function selectUnit(u){
  document.querySelectorAll('.unit.selected').forEach(x=>x.classList.remove('selected'));
  u.classList.add('selected');
  state.selectedUnit=u;
  state.selectedText=decodeURIComponent(u.dataset.text||'');
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

async function loadFile(f){
  try{
    const txt=await f.text();
    const data=JSON.parse(txt);
    if(state.sources.find(s=>s.fname===f.name))return;
    const ex=extract(data,f.name);
    if(ex.pairs.length)state.sources.push(ex);
  }catch(e){console.error(e);}
}

async function autoLoad(){
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok)continue;
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.pairs.length)state.sources.push(ex);
    }catch(e){}
  }
  build();renderStats();renderCases();
}

// Events
$('#drop').onclick=()=>$('#files').click();
$('#drop').ondragover=e=>{e.preventDefault();$('#drop').classList.add('over');};
$('#drop').ondragleave=()=>$('#drop').classList.remove('over');
$('#drop').ondrop=async e=>{
  e.preventDefault();$('#drop').classList.remove('over');
  for(const f of e.dataTransfer.files)await loadFile(f);
  build();renderStats();renderCases();
};
$('#files').onchange=async e=>{
  for(const f of e.target.files)await loadFile(f);
  build();renderStats();renderCases();
};

document.querySelector('.column-tab').onclick=()=>document.querySelector('.column').classList.toggle('collapsed');
document.querySelector('.collapse-hint').onclick=()=>document.querySelector('.column').classList.toggle('collapsed');

// Intro toggle
$('#intro-toggle').onclick=()=>{
  const intro=$('#intro');
  const hidden=intro.style.display==='none';
  intro.style.display=hidden?'block':'none';
  $('#intro-toggle').textContent=hidden?'[HIDE INTRO]':'[SHOW INTRO]';
};

// Keyboard shortcuts
document.onkeydown=e=>{
  if(e.key==='c'&&!e.ctrlKey&&!e.metaKey&&state.selectedText){copyText(state.selectedText);e.preventDefault();}
  if(e.key==='h'&&!e.ctrlKey&&!e.metaKey){$('#intro-toggle').click();e.preventDefault();}
  if(e.key==='ArrowRight'){$('#scroll').scrollBy({left:300,behavior:'smooth'});}
  if(e.key==='ArrowLeft'){$('#scroll').scrollBy({left:-300,behavior:'smooth'});}
};

// Long press for mobile copy
let pressTimer;
document.addEventListener('touchstart',e=>{
  const unit=e.target.closest('.unit[data-text]');
  if(!unit)return;
  pressTimer=setTimeout(()=>{
    const txt=decodeURIComponent(unit.dataset.text||'');
    copyText(txt);
  },600);
});
document.addEventListener('touchend',()=>clearTimeout(pressTimer));
document.addEventListener('touchmove',()=>clearTimeout(pressTimer));

autoLoad();
</script>
</body>
</html>
