<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THE REPUBLIC ‚Äî Comparison Reader</title>
<link rel="icon" type="image/svg+xml" href="favicon-compare.svg">
<style>
/* Dark Theme (default) */
:root{
  --bg:#0a0a0a;--bg2:#111;--panel:#161616;
  --fg:#f0f0f0;--dim:#a0a0a0;--muted:#606060;
  --accent:#d4a853;--accent2:#e8c47a;
  --source:#f43f5e;--prompt:#60a5fa;--response:#34d399;
  --r1:#34d399;--r2:#a78bfa;--r3:#fbbf24;--r4:#f472b6;--r5:#22d3ee;--r6:#fb923c;
  --border:#2a2a2a;--border2:#3a3a3a;
  --success:#22c55e;--error:#ef4444;
  --shadow:rgba(0,0,0,.4);
}
/* Light Theme */
[data-theme="light"]{
  --bg:#faf9f7;--bg2:#f0efec;--panel:#fff;
  --fg:#1a1a1a;--dim:#4a4a4a;--muted:#888;
  --accent:#8b5a2b;--accent2:#a67c52;
  --source:#dc2626;--prompt:#2563eb;--response:#059669;
  --r1:#059669;--r2:#7c3aed;--r3:#d97706;--r4:#db2777;--r5:#0891b2;--r6:#ea580c;
  --border:#e0ddd8;--border2:#d0cdc8;
  --shadow:rgba(0,0,0,.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:var(--bg);color:var(--fg);overflow:hidden;font-size:13px;line-height:1.75;transition:background .3s,color .3s}

/* Haptic feedback */
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
@keyframes glow{0%{box-shadow:0 0 0 0 rgba(212,168,83,.4)}70%{box-shadow:0 0 0 8px rgba(212,168,83,0)}100%{box-shadow:0 0 0 0 rgba(212,168,83,0)}}
.haptic-pulse{animation:pulse .15s ease}
.haptic-shake{animation:shake .2s ease}
.haptic-glow{animation:glow .4s ease}

/* Header - Compact */
.header{position:fixed;top:0;left:0;right:0;height:44px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;z-index:100;gap:8px}
.logo{font-weight:600;font-size:12px;color:var(--accent);display:flex;align-items:center;gap:6px}
.logo svg{width:16px;height:16px}
.logo span{display:none}
.breadcrumb{display:none}
.panel-count{font-size:9px;color:var(--muted);padding:3px 6px;background:var(--bg);border:1px solid var(--border);border-radius:3px}
.panel-count b{color:var(--accent)}

/* Search Bar */
.search-bar{flex:1;max-width:280px;position:relative}
.search-bar input{width:100%;padding:6px 10px 6px 28px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--fg);font:inherit;font-size:10px;transition:all .15s}
.search-bar input:focus{outline:none;border-color:var(--accent)}
.search-bar input::placeholder{color:var(--muted)}
.search-bar svg{position:absolute;left:8px;top:50%;transform:translateY(-50%);width:12px;height:12px;color:var(--muted);pointer-events:none}
.search-bar input:focus+svg{color:var(--accent)}
.search-results{position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--border);border-radius:4px;margin-top:4px;max-height:200px;overflow-y:auto;display:none;z-index:10}
.search-bar.active .search-results{display:block}
.search-result{padding:8px 10px;font-size:10px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center}
.search-result:last-child{border-bottom:none}
.search-result:hover{background:var(--bg2)}
.search-result-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.search-result-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--dim)}
.search-result mark{background:var(--accent);color:#000;padding:0 2px;border-radius:2px}

.header-actions{margin-left:auto;display:flex;gap:4px}
.icon-btn{width:32px;height:32px;padding:0;background:var(--bg);border:1px solid var(--border);color:var(--muted);cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn svg{width:14px;height:14px}
.icon-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.icon-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.icon-btn.primary:hover{background:var(--accent2)}

/* Main Layout */
.scroll-container{display:flex;height:calc(100vh - 44px);margin-top:44px;overflow-x:auto;overflow-y:hidden;scroll-behavior:smooth}
.scroll-container::-webkit-scrollbar{height:6px}
.scroll-container::-webkit-scrollbar-track{background:var(--bg2)}
.scroll-container::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.scroll-container::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* Columns - Compact */
.column{min-width:320px;width:320px;height:100%;border-right:1px solid var(--border);background:var(--bg);display:flex;flex-direction:column;flex-shrink:0;transition:all .2s ease;position:relative}
.column.collapsed{min-width:36px;width:36px}
.column-tab{writing-mode:vertical-rl;text-orientation:mixed;padding:12px 0;background:var(--bg2);cursor:pointer;text-align:center;font-size:8px;letter-spacing:.1em;color:var(--muted);transition:all .2s;user-select:none;position:absolute;top:0;left:0;width:36px;height:100%;z-index:10;opacity:0;display:flex;align-items:center;justify-content:center}
.column.collapsed .column-tab{opacity:1}
.column-tab:hover{background:var(--panel);color:var(--dim)}
.column-tab-dot{width:5px;height:5px;border-radius:50%;margin-bottom:8px}

/* Column Header - Tight */
.column-header{height:40px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0}
.column.collapsed .column-header{opacity:0;pointer-events:none}
.column-info{display:flex;align-items:center;gap:8px;overflow:hidden}
.column-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.column-title{font-size:10px;letter-spacing:.03em;color:var(--fg);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.column-subtitle{display:none}
.column-actions{display:flex;gap:2px}
.col-btn{width:24px;height:24px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer;border-radius:3px;display:flex;align-items:center;justify-content:center;transition:all .1s}
.col-btn:hover{border-color:var(--border);color:var(--accent);background:var(--bg)}
.col-btn.close:hover{color:var(--error)}
.col-btn.copy:hover{color:var(--success)}
.col-btn svg{width:11px;height:11px}
.col-btn.active{background:var(--accent);color:#fff}

/* Color coding by type: Sources (red), Prompts (blue), Responses (green) */
.column[data-type="cases"] .column-dot{background:var(--source)}
.column[data-type="cases"] .column-tab-dot{background:var(--source)}
.column[data-type="prompt"] .column-dot{background:var(--prompt)}
.column[data-type="prompt"] .column-tab-dot{background:var(--prompt)}
.column[data-type="witness"] .column-dot{background:var(--response)}
.column[data-type="witness"] .column-tab-dot{background:var(--response)}
.column[data-color="1"] .column-dot,.column[data-color="1"] .column-tab-dot{background:var(--r1)}
.column[data-color="2"] .column-dot,.column[data-color="2"] .column-tab-dot{background:var(--r2)}
.column[data-color="3"] .column-dot,.column[data-color="3"] .column-tab-dot{background:var(--r3)}
.column[data-color="4"] .column-dot,.column[data-color="4"] .column-tab-dot{background:var(--r4)}
.column[data-color="5"] .column-dot,.column[data-color="5"] .column-tab-dot{background:var(--r5)}
.column[data-color="6"] .column-dot,.column[data-color="6"] .column-tab-dot{background:var(--r6)}

/* Column Content */
.column-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:16px;opacity:1;transition:opacity .3s}
.column.collapsed .column-content{opacity:0;pointer-events:none}
.column-content::-webkit-scrollbar{width:6px}
.column-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Control Panel (replaces modal) */
.column.control-panel{background:var(--panel);min-width:300px;width:300px}
.column.control-panel .column-dot{background:var(--accent)}
.control-tabs{display:flex;border-bottom:1px solid var(--border)}
.control-tab{flex:1;padding:12px 8px;background:transparent;border:none;color:var(--muted);font:inherit;font-size:9px;cursor:pointer;text-transform:uppercase;letter-spacing:.03em;border-bottom:2px solid transparent;transition:all .15s}
.control-tab:hover{color:var(--dim);background:var(--bg)}
.control-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.control-content{display:none;padding:12px}
.control-content.active{display:block}
.control-search{margin-bottom:12px}
.control-search input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:11px}
.control-search input:focus{outline:none;border-color:var(--accent)}
.control-list{max-height:calc(100vh - 220px);overflow-y:auto}
.control-item{padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.control-item:hover{border-color:var(--accent);background:rgba(212,168,83,.05)}
.control-item-title{font-size:11px;color:var(--fg);margin-bottom:4px;font-weight:500}
.control-item-meta{font-size:9px;color:var(--muted)}
.control-item-btn{margin-top:8px;padding:8px 14px;background:var(--accent);border:none;border-radius:4px;color:#000;font:inherit;font-size:9px;font-weight:bold;cursor:pointer;width:100%}
.control-item-btn:hover{background:var(--accent2)}
.control-paste textarea{width:100%;height:150px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:11px;resize:none;margin-bottom:8px}
.control-paste input{width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:11px;margin-bottom:8px}

/* Multi-select lines */
.text-line.selected{background:rgba(212,168,83,.2);border-left-color:var(--accent)}
.text-line .line-select{width:16px;height:16px;border:1px solid var(--border);border-radius:3px;margin-right:8px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.text-line .line-select:hover{border-color:var(--accent)}
.text-line.selected .line-select{background:var(--accent);border-color:var(--accent)}
.text-line.selected .line-select::after{content:'‚úì';color:#000;font-size:10px}

/* Selection Toolbar */
.selection-toolbar{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:8px 12px;display:flex;gap:8px;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:200;opacity:0;transition:all .3s;pointer-events:none}
.selection-toolbar.visible{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
.selection-toolbar-count{font-size:10px;color:var(--accent);font-weight:bold;padding-right:8px;border-right:1px solid var(--border)}
.selection-toolbar-btn{padding:8px 14px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--fg);font:inherit;font-size:10px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.selection-toolbar-btn:hover{border-color:var(--accent);color:var(--accent)}
.selection-toolbar-btn.primary{background:var(--accent);border-color:var(--accent);color:#000}
.selection-toolbar-btn svg{width:12px;height:12px}

/* Context Menu */
.context-menu{position:fixed;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px 0;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:400;display:none}
.context-menu.open{display:block}
.context-menu-header{padding:8px 14px;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border)}
.context-menu-item{padding:10px 14px;font-size:11px;color:var(--fg);cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .1s}
.context-menu-item:hover{background:var(--bg);color:var(--accent)}
.context-menu-item svg{width:14px;height:14px;color:var(--muted)}
.context-menu-item:hover svg{color:var(--accent)}
.context-menu-divider{height:1px;background:var(--border);margin:4px 0}
.context-menu-item.danger:hover{background:rgba(239,68,68,.1);color:var(--error)}
.context-menu-item.danger:hover svg{color:var(--error)}

/* Diff Mode */
.diff-toolbar{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:8px 16px;display:none;gap:12px;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:200}
.diff-toolbar.visible{display:flex}
.diff-toolbar-label{font-size:10px;color:var(--accent);font-weight:bold}
.diff-toolbar-btn{padding:6px 12px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--fg);font:inherit;font-size:10px;cursor:pointer}
.diff-toolbar-btn:hover{border-color:var(--accent);color:var(--accent)}
.diff-toolbar-btn.active{background:var(--accent);border-color:var(--accent);color:#000}

/* Diff highlights */
.text-line.diff-added{background:rgba(34,197,94,.15);border-left-color:var(--success)}
.text-line.diff-removed{background:rgba(239,68,68,.15);border-left-color:var(--error)}
.text-line.diff-changed{background:rgba(251,191,36,.15);border-left-color:var(--accent)}
.column.diff-source{box-shadow:inset 0 0 0 2px var(--r1)}
.column.diff-target{box-shadow:inset 0 0 0 2px var(--r2)}

/* Prompt Panel */
.prompt-panel{background:var(--bg2)}
.prompt-panel .column-dot{background:var(--prompt)}
.prompt-input{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:11px;resize:none;min-height:100px;margin-bottom:8px}
.prompt-input:focus{outline:none;border-color:var(--accent)}
.prompt-context{padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;margin-bottom:12px;max-height:150px;overflow-y:auto}
.prompt-context-label{font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:6px}
.prompt-context-text{font-size:10px;color:var(--dim);line-height:1.5}
.prompt-actions{display:flex;gap:8px}
.prompt-btn{flex:1;padding:12px;background:var(--accent);border:none;border-radius:6px;color:#000;font:inherit;font-size:11px;font-weight:bold;cursor:pointer}
.prompt-btn:hover{background:var(--accent2)}
.prompt-btn.secondary{background:var(--bg);border:1px solid var(--border);color:var(--fg)}

/* Cards - Compact */
.unit{margin-bottom:8px;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:4px;cursor:pointer;transition:all .1s;position:relative}
.unit:hover{border-color:var(--border2)}
.unit.active,.unit.selected{border-color:var(--accent);background:var(--bg2)}
.unit.highlight{background:rgba(212,168,83,.1);border-color:var(--accent)}
.unit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.unit-id{font-size:8px;color:var(--muted);letter-spacing:.03em}
.unit-badge{font-size:7px;padding:2px 5px;background:var(--bg);border:1px solid var(--border);border-radius:2px;color:var(--muted)}
.unit-text{color:var(--dim);line-height:1.55;font-size:11px}
.unit.active .unit-text,.unit.selected .unit-text{color:var(--fg)}
.unit-meta{font-size:8px;color:var(--muted);margin-top:6px;display:flex;gap:8px}
.unit-meta span{display:flex;align-items:center;gap:2px}

/* Line Numbers - Tight */
.lined-content{counter-reset:line;font-size:11px;line-height:1.5}
.text-line{display:flex;padding:0;border-left:2px solid transparent;transition:all .1s}
.text-line:hover{background:var(--bg2);border-left-color:var(--muted)}
.text-line.highlight,.text-line.search-match{background:rgba(212,168,83,.15);border-left-color:var(--accent)}
.line-num{width:28px;flex-shrink:0;text-align:right;padding-right:8px;font-size:9px;color:var(--muted);user-select:none;opacity:.4}
.line-text{flex:1;color:var(--fg);word-break:break-word}
.line-text mark{background:var(--accent);color:#000;padding:0 1px;border-radius:1px}

/* Stats */
.stat{padding:10px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:10px}
.stat-label{color:var(--muted)}
.stat-value{color:var(--accent);font-weight:bold}

/* Copy & Actions */
.copy-btn{position:absolute;top:10px;right:10px;font-size:8px;padding:5px 10px;background:var(--panel);border:1px solid var(--border);color:var(--muted);cursor:pointer;opacity:0;transition:all .2s;border-radius:4px;display:flex;align-items:center;gap:4px}
.unit:hover .copy-btn{opacity:1}
.copy-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(212,168,83,.05)}
.copy-btn.copied{background:var(--success);border-color:var(--success);color:#fff;opacity:1}
.copy-btn svg{width:10px;height:10px}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);font-size:11px;color:#000;background:var(--accent);padding:12px 24px;border-radius:6px;opacity:0;transition:all .3s cubic-bezier(.4,0,.2,1);z-index:200;font-weight:bold;box-shadow:0 4px 20px rgba(212,168,83,.3);display:flex;align-items:center;gap:8px}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast svg{width:16px;height:16px}
.toast.success{background:var(--success)}
.toast.error{background:var(--error);color:#fff}

/* Help */
.help{position:fixed;bottom:12px;right:20px;font-size:9px;color:var(--muted);background:var(--panel);padding:6px 12px;border-radius:4px;border:1px solid var(--border)}

/* Add Panel Modal - Redesigned */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;width:95%;max-width:600px;max-height:85vh;overflow:hidden;animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:13px;color:var(--accent);font-weight:bold;letter-spacing:.05em}
.modal-close{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0 4px;transition:color .15s}
.modal-close:hover{color:var(--fg)}

/* Modal Tabs */
.modal-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg2)}
.modal-tab{flex:1;padding:12px 16px;background:transparent;border:none;color:var(--muted);font:inherit;font-size:10px;cursor:pointer;text-transform:uppercase;letter-spacing:.05em;transition:all .15s;border-bottom:2px solid transparent}
.modal-tab:hover{color:var(--dim);background:var(--bg)}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--panel)}

/* Modal Search */
.modal-search{padding:12px 20px;border-bottom:1px solid var(--border)}
.modal-search input{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:12px}
.modal-search input:focus{outline:none;border-color:var(--accent)}
.modal-search input::placeholder{color:var(--muted)}

.modal-body{padding:16px 20px;max-height:55vh;overflow-y:auto}
.modal-section{margin-bottom:16px}
.modal-section-title{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.modal-section-title::after{content:'';flex:1;height:1px;background:var(--border)}

/* Quick Add Buttons */
.quick-add{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.quick-btn{padding:10px 16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:8px;font-size:11px;color:var(--fg)}
.quick-btn:hover{border-color:var(--accent);background:rgba(212,168,83,.05)}
.quick-btn svg{width:14px;height:14px;color:var(--accent)}
.quick-btn.primary{background:var(--accent);border-color:var(--accent);color:#000}
.quick-btn.primary:hover{background:var(--accent2)}

/* Source Grid */
.source-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.source-btn{padding:14px 16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .15s;text-align:left;position:relative}
.source-btn:hover{border-color:var(--accent);background:rgba(212,168,83,.05)}
.source-btn.selected{border-color:var(--accent);background:rgba(212,168,83,.1)}
.source-btn-name{font-size:11px;color:var(--fg);margin-bottom:4px;font-weight:600}
.source-btn-count{font-size:9px;color:var(--muted)}
.source-btn-check{position:absolute;top:8px;right:8px;width:16px;height:16px;background:var(--accent);border-radius:50%;display:none;align-items:center;justify-content:center}
.source-btn.selected .source-btn-check{display:flex}
.source-btn-check svg{width:10px;height:10px;color:#000}

/* Witness List */
.witness-list{display:flex;flex-direction:column;gap:6px;max-height:250px;overflow-y:auto}
.witness-item{padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .15s;display:flex;justify-content:space-between;align-items:center;gap:12px}
.witness-item:hover{border-color:var(--accent);background:rgba(212,168,83,.05)}
.witness-item.selected{border-color:var(--accent);background:rgba(212,168,83,.1)}
.witness-item-info{flex:1;min-width:0}
.witness-item-title{font-size:11px;color:var(--fg);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.witness-item-meta{font-size:9px;color:var(--muted)}
.witness-item-add{font-size:9px;padding:6px 14px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:bold;white-space:nowrap}
.witness-item-add:hover{background:var(--accent2)}

/* Paste Area */
.paste-area{border:2px dashed var(--border);border-radius:8px;padding:24px;text-align:center;cursor:pointer;transition:all .2s}
.paste-area:hover,.paste-area.over{border-color:var(--accent);background:rgba(212,168,83,.03)}
.paste-area-icon{font-size:32px;color:var(--muted);margin-bottom:12px}
.paste-area-text{font-size:11px;color:var(--dim);margin-bottom:8px}
.paste-area-hint{font-size:9px;color:var(--muted)}
.paste-area textarea{width:100%;height:120px;margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:11px;resize:none}
.paste-area textarea:focus{outline:none;border-color:var(--accent)}

.modal-footer{padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px}
.modal-footer-info{font-size:9px;color:var(--muted)}
.modal-footer-actions{display:flex;gap:8px}
.btn{padding:10px 18px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--dim);font:inherit;font-size:10px;cursor:pointer;transition:all .15s}
.btn:hover{border-color:var(--accent);color:var(--accent)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#000;font-weight:bold}
.btn-primary:hover{background:var(--accent2)}

/* Onboarding Tutorial */
.onboarding{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px}
.onboarding.hidden{display:none}
.onboard-card{background:var(--panel);border:1px solid var(--border);border-radius:16px;width:100%;max-width:480px;overflow:hidden;animation:modalIn .4s ease}
.onboard-header{padding:24px 24px 16px;text-align:center;border-bottom:1px solid var(--border)}
.onboard-logo{font-size:32px;margin-bottom:12px}
.onboard-title{font-size:16px;color:var(--accent);font-weight:bold;letter-spacing:.1em;margin-bottom:8px}
.onboard-subtitle{font-size:11px;color:var(--dim)}
.onboard-steps{padding:20px 24px}
.onboard-step{display:flex;gap:16px;padding:14px 0;border-bottom:1px solid var(--border)}
.onboard-step:last-child{border-bottom:none}
.onboard-num{width:28px;height:28px;background:var(--accent);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;flex-shrink:0}
.onboard-text{flex:1}
.onboard-text h4{font-size:12px;color:var(--fg);margin-bottom:4px}
.onboard-text p{font-size:10px;color:var(--dim);line-height:1.5}
.onboard-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
.onboard-skip{background:none;border:none;color:var(--muted);font:inherit;font-size:10px;cursor:pointer}
.onboard-skip:hover{color:var(--fg)}
.onboard-start{padding:12px 28px;background:var(--accent);border:none;border-radius:8px;color:#000;font:inherit;font-size:12px;font-weight:bold;cursor:pointer}
.onboard-start:hover{background:var(--accent2)}
.onboard-check{display:flex;align-items:center;gap:8px;font-size:10px;color:var(--muted)}
.onboard-check input{accent-color:var(--accent)}

/* Help Panel */
.help-panel{position:fixed;top:44px;right:0;bottom:0;width:320px;background:var(--panel);border-left:1px solid var(--border);transform:translateX(100%);transition:transform .3s ease;z-index:200;display:flex;flex-direction:column}
.help-panel.open{transform:translateX(0)}
.help-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.help-title{font-size:12px;color:var(--accent);font-weight:bold;letter-spacing:.05em}
.help-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0}
.help-close:hover{color:var(--fg)}
.help-content{flex:1;overflow-y:auto;padding:16px 20px}
.help-section{margin-bottom:20px}
.help-section-title{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.help-section-title::after{content:'';flex:1;height:1px;background:var(--border)}
.help-item{padding:10px 0;border-bottom:1px solid var(--border);font-size:11px}
.help-item:last-child{border-bottom:none}
.help-item strong{color:var(--accent)}
.help-item p{color:var(--dim);margin-top:4px;line-height:1.5}
.help-shortcut{display:flex;justify-content:space-between;padding:8px 0}
.help-shortcut kbd{background:var(--bg);border:1px solid var(--border);padding:2px 8px;border-radius:4px;font-size:10px;color:var(--fg)}

/* Mobile FAB */
.mobile-fab{position:fixed;bottom:20px;right:20px;display:none;flex-direction:column;gap:10px;z-index:150}
.fab-btn{width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,.4);transition:all .2s}
.fab-btn svg{width:24px;height:24px}
.fab-btn.primary{background:var(--accent);color:#000}
.fab-btn.primary:hover{transform:scale(1.05)}
.fab-btn.secondary{background:var(--panel);border:1px solid var(--border);color:var(--fg)}
.fab-btn.secondary:hover{border-color:var(--accent)}

/* Mobile action bar */
.mobile-bar{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--panel);border-top:1px solid var(--border);display:none;justify-content:space-around;align-items:center;z-index:100;padding:0 10px}
.mobile-bar-btn{flex:1;height:100%;background:none;border:none;color:var(--muted);font:inherit;font-size:9px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
.mobile-bar-btn:hover,.mobile-bar-btn.active{color:var(--accent)}
.mobile-bar-btn svg{width:20px;height:20px}

@media(max-width:600px){
  .mobile-fab{display:flex}
  .mobile-bar{display:flex}
  .scroll-container{height:calc(100vh - 100px);margin-bottom:60px}
  .help{display:none}
  .help-panel{width:100%;top:40px}
  .column.control-panel{min-width:85vw;width:85vw}
  .selection-toolbar{bottom:140px;left:10px;right:10px;transform:translateX(0) translateY(100px)}
  .selection-toolbar.visible{transform:translateX(0) translateY(0)}
}

/* Column toolbar */
.column-toolbar{display:flex;gap:2px;padding:8px 12px;background:var(--bg2);border-bottom:1px solid var(--border)}
.column.collapsed .column-toolbar{display:none}
.toolbar-btn{padding:6px 10px;background:transparent;border:1px solid transparent;color:var(--muted);font:inherit;font-size:9px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:4px;transition:all .15s}
.toolbar-btn:hover{background:var(--panel);border-color:var(--border);color:var(--dim)}
.toolbar-btn.active{background:var(--accent);color:#000}
.toolbar-btn svg{width:12px;height:12px}
.toolbar-sep{width:1px;background:var(--border);margin:0 4px}

/* Drop zone */
.drop-zone{border:2px dashed var(--border);padding:24px;text-align:center;margin-bottom:16px;cursor:pointer;transition:all .2s;font-size:11px;color:var(--muted);border-radius:6px}
.drop-zone:hover,.drop-zone.over{border-color:var(--accent);color:var(--dim);background:rgba(212,168,83,.03)}

/* Intro */
.intro{padding:16px;margin-bottom:16px;border:1px solid var(--border);background:var(--panel);border-radius:6px;font-size:11px;line-height:1.7;color:var(--dim)}
.intro-title{font-size:12px;color:var(--accent);margin-bottom:10px;letter-spacing:.1em;font-weight:bold}
.intro p{margin-bottom:6px}
.intro-toggle{font-size:9px;color:var(--muted);cursor:pointer;margin-top:10px;text-transform:uppercase}
.intro-toggle:hover{color:var(--accent)}

input[type="file"]{display:none}

@keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-40px)}}
.column.new{animation:slideIn .35s cubic-bezier(.4,0,.2,1)}
.column.removing{animation:slideOut .25s ease-out forwards}

/* Mobile - Ultra Compact */
@media(max-width:600px){
  .header{padding:0 8px;gap:6px;height:40px}
  .logo span{display:none}
  .search-bar{max-width:140px}
  .search-bar input{padding:5px 8px 5px 24px;font-size:9px}
  .search-bar svg{width:10px;height:10px;left:6px}
  .panel-count{display:none}
  .icon-btn{width:28px;height:28px}
  .icon-btn svg{width:12px;height:12px}
  .scroll-container{height:calc(100vh - 100px);margin-top:40px}
  .column{min-width:85vw;width:85vw;scroll-snap-align:center}
  .column.collapsed{min-width:32px;width:32px}
  .column-tab{width:32px;font-size:7px}
  .column-header{height:36px;padding:0 8px}
  .column-title{font-size:9px}
  .col-btn{width:28px;height:28px}
  .col-btn svg{width:12px;height:12px}
  .column-content{padding:12px}
  .unit{padding:12px;margin-bottom:8px}
  .unit-text{font-size:11px}
  .lined-content{font-size:10px}
  .line-num{width:24px;font-size:8px}
  .modal{max-width:95%;max-height:90vh}
  .modal-tab{padding:14px 12px;font-size:9px}
  .witness-item{padding:14px 12px}
  .witness-item-add{padding:10px 16px;font-size:10px}
  .scroll-container{scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
}
@media(max-width:400px){
  .column{min-width:92vw;width:92vw}
  .search-bar{max-width:100px}
}
</style>
</head>
<body>
<header class="header">
  <div class="logo">
    <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12,2 15,9 22,9 16.5,14 18.5,21 12,17 5.5,21 7.5,14 2,9 9,9"/></svg>
  </div>
  <div class="search-bar" id="search-bar">
    <input type="text" id="search-input" placeholder="Search panels..." autocomplete="off">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
    <div class="search-results" id="search-results"></div>
  </div>
  <div class="panel-count"><b id="panel-count">1</b></div>
  <div class="header-actions">
    <button class="icon-btn" id="theme-toggle" title="Theme">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    </button>
    <button class="icon-btn" id="collapse-all" title="Collapse All">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14h16M4 10h16"/></svg>
    </button>
    <button class="icon-btn" id="expand-all" title="Expand All">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
    </button>
    <button class="icon-btn primary" id="add-panel" title="Add Panel">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
    </button>
  </div>
</header>

<!-- Add Panel Modal - Redesigned -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">‚òÖ ADD PANEL</span>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" data-tab="cases">Cases</button>
      <button class="modal-tab" data-tab="witnesses">Witnesses</button>
      <button class="modal-tab" data-tab="paste">Paste Text</button>
    </div>
    <div class="modal-search">
      <input type="text" id="modal-search" placeholder="Search cases and witnesses...">
    </div>
    <div class="modal-body">
      <!-- Cases Tab -->
      <div class="modal-tab-content" id="tab-cases">
        <div class="quick-add" id="quick-cases"></div>
        <div class="modal-section">
          <div class="modal-section-title">All Cases</div>
          <div class="witness-list" id="case-list"></div>
        </div>
      </div>
      <!-- Witnesses Tab -->
      <div class="modal-tab-content" id="tab-witnesses" style="display:none">
        <div class="modal-section">
          <div class="modal-section-title">Select Source First</div>
          <div class="source-grid" id="source-grid"></div>
        </div>
        <div class="modal-section" id="witness-section" style="display:none">
          <div class="modal-section-title">Available Witnesses</div>
          <div class="witness-list" id="witness-list"></div>
        </div>
      </div>
      <!-- Paste Tab -->
      <div class="modal-tab-content" id="tab-paste" style="display:none">
        <div class="paste-area" id="paste-area">
          <div class="paste-area-icon">üìã</div>
          <div class="paste-area-text">Click to paste or type text directly</div>
          <div class="paste-area-hint">Paste screenplay text, dialogue, or any content to compare</div>
          <textarea id="paste-text" placeholder="Paste or type your text here..."></textarea>
        </div>
        <div style="margin-top:12px">
          <input type="text" id="paste-title" placeholder="Panel title (optional)" style="width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:12px">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-info" id="modal-info">Select an item to add</div>
      <div class="modal-footer-actions">
        <button class="btn" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-add" style="display:none">+ Add Panel</button>
      </div>
    </div>
  </div>
</div>
<div class="scroll-container" id="scroll">
<div class="column" data-type="cases" data-index="0">
<div class="column-tab"><div class="column-tab-dot"></div>CASES</div>
<div class="column-header">
  <div class="column-info">
    <div class="column-dot"></div>
    <div><div class="column-title">CASES</div><div class="column-subtitle" id="case-count">loading...</div></div>
  </div>
  <div class="column-actions">
    <button class="col-btn" title="Collapse" onclick="this.closest('.column').classList.toggle('collapsed')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
  </div>
</div>
<div class="column-content">
<div class="intro" id="intro">
<div class="intro-title">‚òÖ COMPARISON READER</div>
<p>Compare prompt/completion pairs across multiple sources. Select a case to see all witness responses side-by-side with line numbers.</p>
<p><b>Controls:</b> Click to select ‚Ä¢ Double-click to copy ‚Ä¢ Keyboard: C=copy, H=help, ‚Üê‚Üí=scroll</p>
<div class="intro-toggle" id="intro-toggle">[HIDE]</div>
</div>
<div class="drop-zone" id="drop">+ DROP JSON OR CLICK TO ADD<input type="file" id="files" multiple accept=".json"></div>
<div id="stats"></div>
<div id="cases"></div>
</div>
</div>
</div>
<div class="toast" id="toast">COPIED</div>
<div class="help">C=copy H=help ‚Üê‚Üí=scroll</div>

<!-- Selection Toolbar -->
<div class="selection-toolbar" id="selection-toolbar">
  <span class="selection-toolbar-count" id="selection-count">0 lines</span>
  <button class="selection-toolbar-btn primary" id="sel-copy">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
    Copy
  </button>
  <button class="selection-toolbar-btn" id="sel-all">Select All</button>
  <button class="selection-toolbar-btn" id="sel-clear">Clear</button>
</div>

<!-- Context Menu -->
<div class="context-menu" id="context-menu">
  <div class="context-menu-header">Actions</div>
  <div class="context-menu-item" id="ctx-copy">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
    Copy Selected
  </div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" id="ctx-branch">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 009 9"/></svg>
    Branch from Selection
  </div>
  <div class="context-menu-item" id="ctx-prompt">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
    Use as Prompt ‚Üí
  </div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" id="ctx-diff">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5M8 3H3v5M3 16v5h5M21 16v5h-5M12 8v8M8 12h8"/></svg>
    Compare with Panel...
  </div>
  <div class="context-menu-item" id="ctx-highlight">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    Highlight Differences
  </div>
</div>

<!-- Diff Toolbar -->
<div class="diff-toolbar" id="diff-toolbar">
  <span class="diff-toolbar-label">DIFF MODE</span>
  <button class="diff-toolbar-btn" id="diff-prev">‚Üê Prev</button>
  <span id="diff-count">0 differences</span>
  <button class="diff-toolbar-btn" id="diff-next">Next ‚Üí</button>
  <button class="diff-toolbar-btn" id="diff-exit">Exit Diff</button>
</div>

<!-- Onboarding Tutorial -->
<div class="onboarding" id="onboarding">
  <div class="onboard-card">
    <div class="onboard-header">
      <div class="onboard-logo">‚òÖ</div>
      <div class="onboard-title">COMPARISON READER</div>
      <div class="onboard-subtitle">Compare prompts & responses across multiple sources</div>
    </div>
    <div class="onboard-steps">
      <div class="onboard-step">
        <div class="onboard-num">1</div>
        <div class="onboard-text">
          <h4>Load Your Data</h4>
          <p>Drop JSON files into the Cases panel, or use the pre-loaded sample data to explore.</p>
        </div>
      </div>
      <div class="onboard-step">
        <div class="onboard-num">2</div>
        <div class="onboard-text">
          <h4>Select a Case</h4>
          <p>Click any case to see its prompt and all witness responses side-by-side in columns.</p>
        </div>
      </div>
      <div class="onboard-step">
        <div class="onboard-num">3</div>
        <div class="onboard-text">
          <h4>Add More Panels</h4>
          <p>Tap the <b>+</b> button to add cases, witnesses, or paste your own text to compare.</p>
        </div>
      </div>
      <div class="onboard-step">
        <div class="onboard-num">4</div>
        <div class="onboard-text">
          <h4>Copy & Export</h4>
          <p>Double-tap any panel to copy. Long-press on mobile. Use toolbar buttons to export.</p>
        </div>
      </div>
    </div>
    <div class="onboard-footer">
      <label class="onboard-check">
        <input type="checkbox" id="onboard-remember"> Don't show again
      </label>
      <button class="onboard-start" id="onboard-start">GET STARTED ‚Üí</button>
    </div>
  </div>
</div>

<!-- Help Panel -->
<div class="help-panel" id="help-panel">
  <div class="help-header">
    <span class="help-title">‚òÖ HELP & SHORTCUTS</span>
    <button class="help-close" id="help-close">&times;</button>
  </div>
  <div class="help-content">
    <div class="help-section">
      <div class="help-section-title">Getting Started</div>
      <div class="help-item">
        <strong>Load Data</strong>
        <p>Drop JSON files into the Cases panel or click the drop zone to browse files.</p>
      </div>
      <div class="help-item">
        <strong>Select a Case</strong>
        <p>Click any case card to view its prompt and all witness responses in side-by-side columns.</p>
      </div>
      <div class="help-item">
        <strong>Add Panels</strong>
        <p>Click the + button to add more cases, witnesses from a source, or paste custom text.</p>
      </div>
    </div>
    <div class="help-section">
      <div class="help-section-title">Keyboard Shortcuts</div>
      <div class="help-shortcut"><span>Copy selected</span><kbd>C</kbd></div>
      <div class="help-shortcut"><span>Toggle help</span><kbd>H</kbd></div>
      <div class="help-shortcut"><span>Search</span><kbd>‚åò/Ctrl + F</kbd></div>
      <div class="help-shortcut"><span>Scroll panels</span><kbd>‚Üê ‚Üí</kbd></div>
      <div class="help-shortcut"><span>Close modal</span><kbd>Esc</kbd></div>
    </div>
    <div class="help-section">
      <div class="help-section-title">Mobile Gestures</div>
      <div class="help-item">
        <strong>Swipe</strong>
        <p>Swipe left/right to navigate between panels.</p>
      </div>
      <div class="help-item">
        <strong>Long Press</strong>
        <p>Hold on any panel to copy its contents to clipboard.</p>
      </div>
      <div class="help-item">
        <strong>Double Tap</strong>
        <p>Double-tap a panel to quickly copy it.</p>
      </div>
    </div>
    <div class="help-section">
      <div class="help-section-title">Tips</div>
      <div class="help-item">
        <strong>Collapse Panels</strong>
        <p>Click the collapse button or the vertical tab to minimize panels you don't need.</p>
      </div>
      <div class="help-item">
        <strong>Search</strong>
        <p>Use the search bar to find text across all panels. Click results to jump to matches.</p>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Bottom Bar -->
<div class="mobile-bar" id="mobile-bar">
  <button class="mobile-bar-btn" id="mob-add">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
    Add
  </button>
  <button class="mobile-bar-btn" id="mob-search">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
    Search
  </button>
  <button class="mobile-bar-btn" id="mob-help">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3M12 17h.01"/></svg>
    Help
  </button>
  <button class="mobile-bar-btn" id="mob-copy">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
    Copy
  </button>
</div>

<script>
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];
const state={sources:[],cases:new Map(),activeCase:null,colIndex:0,selectedText:'',selectedUnit:null};

// Theme toggle
const savedTheme=localStorage.getItem('republic-theme')||'dark';
document.body.dataset.theme=savedTheme;
updateThemeIcon();

function updateThemeIcon(){
  const icon=$('#theme-icon');
  if(document.body.dataset.theme==='light'){
    icon.innerHTML='<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
  }else{
    icon.innerHTML='<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
  }
}

$('#theme-toggle').onclick=()=>{
  const theme=document.body.dataset.theme==='dark'?'light':'dark';
  document.body.dataset.theme=theme;
  localStorage.setItem('republic-theme',theme);
  updateThemeIcon();
};

// Search functionality
const searchInput=$('#search-input');
const searchBar=$('#search-bar');
const searchResults=$('#search-results');
let searchTimeout;

searchInput.oninput=()=>{
  clearTimeout(searchTimeout);
  searchTimeout=setTimeout(doSearch,150);
};
searchInput.onfocus=()=>{if(searchInput.value.length>1)searchBar.classList.add('active');};
searchInput.onblur=()=>{setTimeout(()=>searchBar.classList.remove('active'),200);};

function doSearch(){
  const q=searchInput.value.trim().toLowerCase();
  if(q.length<2){searchBar.classList.remove('active');return;}
  
  const results=[];
  // Search all visible panels
  $$('.column').forEach(col=>{
    const title=col.querySelector('.column-title')?.textContent||'';
    const type=col.dataset.type||'';
    const color=col.dataset.color||'1';
    
    // Search line content
    col.querySelectorAll('.line-text').forEach((line,i)=>{
      const text=line.textContent.toLowerCase();
      if(text.includes(q)){
        const snippet=line.textContent.slice(0,60);
        results.push({col,title,type,color,line,lineNum:i+1,snippet,q});
      }
    });
    
    // Search units
    col.querySelectorAll('.unit-text').forEach(unit=>{
      const text=unit.textContent.toLowerCase();
      if(text.includes(q)){
        results.push({col,title,type,color,unit,snippet:unit.textContent.slice(0,60),q});
      }
    });
  });
  
  if(results.length===0){
    searchResults.innerHTML='<div class="search-result" style="color:var(--muted)">No results</div>';
  }else{
    searchResults.innerHTML=results.slice(0,10).map(r=>{
      const colorVar=`var(--r${r.color})`;
      const highlighted=r.snippet.replace(new RegExp(`(${r.q})`,'gi'),'<mark>$1</mark>');
      return `<div class="search-result" data-col-id="${r.col.id||''}" data-line="${r.lineNum||''}">
        <span class="search-result-dot" style="background:${colorVar}"></span>
        <span class="search-result-text">${highlighted}</span>
      </div>`;
    }).join('');
    
    // Click handlers
    searchResults.querySelectorAll('.search-result').forEach((el,i)=>{
      el.onclick=()=>{
        const r=results[i];
        if(r.line){
          r.line.classList.add('search-match');
          r.line.scrollIntoView({behavior:'smooth',block:'center'});
          setTimeout(()=>r.line.classList.remove('search-match'),2000);
        }else if(r.unit){
          r.unit.closest('.unit')?.classList.add('highlight');
          r.unit.scrollIntoView({behavior:'smooth',block:'center'});
          setTimeout(()=>r.unit.closest('.unit')?.classList.remove('highlight'),2000);
        }
        r.col.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
        searchBar.classList.remove('active');
      };
    });
  }
  searchBar.classList.add('active');
}

// Keyboard shortcut for search
document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey)&&e.key==='f'){
    e.preventDefault();
    searchInput.focus();
    searchInput.select();
  }
  if(e.key==='Escape'){
    searchBar.classList.remove('active');
    searchInput.blur();
  }
});

function toast(msg,type=''){const t=$('#toast');t.className='toast '+type;t.innerHTML=(type==='success'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>':'')+(type==='error'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>':'')+msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500);}
function copyText(txt){if(!txt)return;navigator.clipboard.writeText(txt).then(()=>toast('COPIED'));}
function updateBreadcrumb(){
  const parts=['COMPARISON READER'];
  if(state.activeCase){
    const c=state.cases.get(state.activeCase);
    if(c){const t=c.prompt.split('\n')[0]||'CASE';parts.push(t.slice(0,40)+(t.length>40?'...':''));}
  }
  $('#bc-level').textContent=parts.join(' / ');
}

function hash(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i)|0;return'C'+Math.abs(h).toString(16).toUpperCase().slice(0,8)}

function extract(data,fname){
  const pairs=[];
  const title=data.metadata?.title||fname.replace('.json','');
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        let comp='';
        if(data.messages[i+1]?.role==='Response')comp=data.messages[i+1].say||'';
        if(comp)pairs.push({prompt:m.say,comp,key:hash(m.say.trim().replace(/\s+/g,' '))});
      }
    }
  }
  return{fname,title,pairs};
}

function build(){
  state.cases.clear();
  for(const src of state.sources){
    for(const p of src.pairs){
      if(!state.cases.has(p.key))state.cases.set(p.key,{id:p.key,prompt:p.prompt,witnesses:[]});
      state.cases.get(p.key).witnesses.push({source:src.title,fname:src.fname,text:p.comp});
    }
  }
}

function renderStats(){
  let total=0;
  state.cases.forEach(c=>total+=c.witnesses.length);
  const multi=[...state.cases.values()].filter(c=>c.witnesses.length>1).length;
  $('#stats').innerHTML=`
    <div class="stat"><span class="stat-label">SOURCES</span><span class="stat-value">${state.sources.length}</span></div>
    <div class="stat"><span class="stat-label">CASES</span><span class="stat-value">${state.cases.size}</span></div>
    <div class="stat"><span class="stat-label">MULTI-WITNESS</span><span class="stat-value">${multi}</span></div>
  `;
  $('#case-count').textContent=state.cases.size+' grouped prompts';
}

function renderCases(){
  let html='',i=0;
  for(const[k,c]of state.cases){
    i++;
    const title=c.prompt.split('\n').find(l=>l.trim())||'Untitled';
    const sources=c.witnesses.map(w=>w.source.slice(0,10)).join(', ');
    const multi=c.witnesses.length>1;
    html+=`<div class="unit" data-id="${k}">
      <div class="unit-header">
        <div class="unit-id">CASE ${String(i).padStart(3,'0')}</div>
        <div class="unit-badge">${c.witnesses.length} source${multi?'s':''}</div>
      </div>
      <div class="unit-text">${esc(title.slice(0,120))}</div>
      <div class="unit-meta">
        <span><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg>${sources}</span>
      </div>
    </div>`;
  }
  $('#cases').innerHTML=html||'<div style="color:var(--muted);padding:24px;text-align:center">No cases loaded. Drop JSON files above.</div>';
  document.querySelectorAll('#cases .unit').forEach(u=>{
    u.onclick=()=>selectCase(u.dataset.id);
  });
}

function formatWithLines(text,type){
  const lines=text.split('\n');
  let html='<div class="lined-content">';
  lines.forEach((line,i)=>{
    const num=i+1;
    const escaped=esc(line)||'&nbsp;';
    html+=`<div class="text-line" data-line="${num}"><span class="line-select"></span><span class="line-num">${num}</span><span class="line-text">${escaped}</span></div>`;
  });
  html+='</div>';
  return html;
}

// Multi-select state
const selection={lines:[],lastClick:null};

function updateSelectionToolbar(){
  const toolbar=$('#selection-toolbar');
  const count=$('#selection-count');
  if(selection.lines.length>0){
    toolbar.classList.add('visible');
    count.textContent=`${selection.lines.length} line${selection.lines.length>1?'s':''}`;
  }else{
    toolbar.classList.remove('visible');
  }
}

function getSelectedText(){
  return selection.lines.map(l=>l.querySelector('.line-text')?.textContent||'').join('\n');
}

function clearSelection(){
  selection.lines.forEach(l=>l.classList.remove('selected'));
  selection.lines=[];
  selection.lastClick=null;
  updateSelectionToolbar();
}

function toggleLineSelection(line,e){
  if(e?.shiftKey&&selection.lastClick){
    // Range selection
    const allLines=[...document.querySelectorAll('.text-line')];
    const start=allLines.indexOf(selection.lastClick);
    const end=allLines.indexOf(line);
    const [from,to]=[Math.min(start,end),Math.max(start,end)];
    for(let i=from;i<=to;i++){
      if(!selection.lines.includes(allLines[i])){
        selection.lines.push(allLines[i]);
        allLines[i].classList.add('selected');
      }
    }
  }else{
    if(selection.lines.includes(line)){
      selection.lines=selection.lines.filter(l=>l!==line);
      line.classList.remove('selected');
    }else{
      selection.lines.push(line);
      line.classList.add('selected');
    }
  }
  selection.lastClick=line;
  updateSelectionToolbar();
}

// Selection toolbar handlers
$('#sel-copy')?.addEventListener('click',()=>{
  const text=getSelectedText();
  if(text){
    copyText(text);
    toast(`Copied ${selection.lines.length} lines!`,'success');
  }
});

$('#sel-clear')?.addEventListener('click',clearSelection);

$('#sel-all')?.addEventListener('click',()=>{
  const activeColumn=document.querySelector('.column:not(.collapsed):not([data-type="cases"]):not(.control-panel)');
  if(activeColumn){
    const lines=activeColumn.querySelectorAll('.text-line');
    lines.forEach(l=>{
      if(!selection.lines.includes(l)){
        selection.lines.push(l);
        l.classList.add('selected');
      }
    });
    updateSelectionToolbar();
  }
});

// ============ CONTEXT MENU ============
const contextMenu=$('#context-menu');
let contextTarget=null;
let contextColumn=null;

function showContextMenu(x,y,target){
  contextTarget=target;
  contextColumn=target?.closest('.column');
  
  // Position menu
  const menuWidth=200;
  const menuHeight=280;
  const posX=Math.min(x,window.innerWidth-menuWidth-10);
  const posY=Math.min(y,window.innerHeight-menuHeight-10);
  
  contextMenu.style.left=posX+'px';
  contextMenu.style.top=posY+'px';
  contextMenu.classList.add('open');
}

function hideContextMenu(){
  contextMenu.classList.remove('open');
  contextTarget=null;
  contextColumn=null;
}

// Right-click handler
document.addEventListener('contextmenu',e=>{
  const line=e.target.closest('.text-line');
  const unit=e.target.closest('.unit');
  const column=e.target.closest('.column');
  
  if(line||unit){
    e.preventDefault();
    showContextMenu(e.clientX,e.clientY,line||unit);
  }
});

// Long press for mobile
let longPressTimer;
let longPressTarget;
document.addEventListener('touchstart',e=>{
  const line=e.target.closest('.text-line');
  const unit=e.target.closest('.unit');
  if(line||unit){
    longPressTarget=line||unit;
    longPressTimer=setTimeout(()=>{
      const touch=e.touches[0];
      showContextMenu(touch.clientX,touch.clientY,longPressTarget);
    },500);
  }
},{passive:true});
document.addEventListener('touchend',()=>{clearTimeout(longPressTimer);},{passive:true});
document.addEventListener('touchmove',()=>{clearTimeout(longPressTimer);},{passive:true});

// Close menu on click outside
document.addEventListener('click',e=>{
  if(!contextMenu.contains(e.target)){
    hideContextMenu();
  }
});

// Context menu actions
$('#ctx-copy')?.addEventListener('click',()=>{
  const text=selection.lines.length>0?getSelectedText():
    (contextTarget?.querySelector('.line-text')?.textContent||
     decodeURIComponent(contextTarget?.closest('.unit')?.dataset.text||''));
  if(text){copyText(text);toast('Copied!','success');}
  hideContextMenu();
});

$('#ctx-branch')?.addEventListener('click',()=>{
  const text=selection.lines.length>0?getSelectedText():
    (contextTarget?.querySelector('.line-text')?.textContent||'');
  if(text){
    createBranchPanel(text);
  }
  hideContextMenu();
});

$('#ctx-prompt')?.addEventListener('click',()=>{
  const text=selection.lines.length>0?getSelectedText():
    (contextTarget?.querySelector('.line-text')?.textContent||
     decodeURIComponent(contextTarget?.closest('.unit')?.dataset.text||''));
  if(text){
    createPromptPanel(text);
  }
  hideContextMenu();
});

$('#ctx-diff')?.addEventListener('click',()=>{
  if(contextColumn){
    startDiffSelection(contextColumn);
  }
  hideContextMenu();
});

$('#ctx-highlight')?.addEventListener('click',()=>{
  // Auto-diff with next panel
  if(contextColumn){
    const nextCol=contextColumn.nextElementSibling;
    if(nextCol&&nextCol.classList.contains('column')&&!nextCol.classList.contains('control-panel')){
      runDiff(contextColumn,nextCol);
    }else{
      toast('Need adjacent panel to compare','error');
    }
  }
  hideContextMenu();
});

// ============ BRANCH & PROMPT PANELS ============
function createBranchPanel(sourceText){
  const colorIdx=(state.colIndex%6)+1;
  const col=document.createElement('div');
  col.className='column prompt-panel new';
  col.dataset.type='branch';
  
  col.innerHTML=`
    <div class="column-tab"><div class="column-tab-dot"></div>BRANCH</div>
    <div class="column-header">
      <div class="column-info">
        <div class="column-dot"></div>
        <div><div class="column-title">‚òÖ BRANCH</div></div>
      </div>
      <div class="column-actions">
        <button class="col-btn close" title="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
    <div class="column-content">
      <div class="prompt-context">
        <div class="prompt-context-label">Branching from:</div>
        <div class="prompt-context-text">${esc(sourceText.slice(0,200))}${sourceText.length>200?'...':''}</div>
      </div>
      <textarea class="prompt-input" placeholder="Continue, modify, or expand on this text..."></textarea>
      <div class="prompt-actions">
        <button class="prompt-btn secondary branch-copy">Copy All</button>
        <button class="prompt-btn branch-create">Create Panel ‚Üí</button>
      </div>
    </div>
  `;
  
  $('#scroll').appendChild(col);
  
  // Bind actions
  col.querySelector('.col-btn.close').onclick=()=>{
    col.classList.add('removing');
    setTimeout(()=>{col.remove();updatePanelCount();},250);
  };
  col.querySelector('.column-tab').onclick=()=>col.classList.toggle('collapsed');
  
  col.querySelector('.branch-copy').onclick=()=>{
    const combined=sourceText+'\\n\\n'+col.querySelector('.prompt-input').value;
    copyText(combined);
    toast('Copied combined text!','success');
  };
  
  col.querySelector('.branch-create').onclick=()=>{
    const newText=col.querySelector('.prompt-input').value;
    if(newText.length<3){toast('Enter some text','error');return;}
    const combined=sourceText+'\\n\\n---\\n\\n'+newText;
    addColumn('witness','BRANCHED',`${combined.split('\\n').length} lines`,`
      <div class="unit" data-text="${encodeURIComponent(combined)}">
        <button class="copy-btn">COPY</button>
        <div class="unit-header">
          <div class="unit-id">BRANCHED</div>
          <div class="unit-badge">${combined.split('\\n').length} lines</div>
        </div>
        ${formatWithLines(combined,'witness')}
      </div>
    `,colorIdx);
    bindLastPanelCopy();
    col.remove();
    updatePanelCount();
    toast('Branch created!','success');
  };
  
  updatePanelCount();
  setTimeout(()=>{
    col.classList.remove('new');
    col.querySelector('.prompt-input').focus();
    $('#scroll').scrollLeft=$('#scroll').scrollWidth;
  },50);
}

function createPromptPanel(contextText){
  const colorIdx=(state.colIndex%6)+1;
  const col=document.createElement('div');
  col.className='column prompt-panel new';
  col.dataset.type='prompt-gen';
  
  col.innerHTML=`
    <div class="column-tab"><div class="column-tab-dot"></div>PROMPT</div>
    <div class="column-header">
      <div class="column-info">
        <div class="column-dot"></div>
        <div><div class="column-title">‚òÖ NEW PROMPT</div></div>
      </div>
      <div class="column-actions">
        <button class="col-btn close" title="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
    <div class="column-content">
      <div class="prompt-context">
        <div class="prompt-context-label">Context:</div>
        <div class="prompt-context-text">${esc(contextText.slice(0,200))}${contextText.length>200?'...':''}</div>
      </div>
      <textarea class="prompt-input" placeholder="Write your prompt here... The context above will be included."></textarea>
      <div class="prompt-actions">
        <button class="prompt-btn secondary prompt-copy">Copy Prompt</button>
        <button class="prompt-btn prompt-generate">Generate ‚Üí Panel</button>
      </div>
      <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:6px;font-size:9px;color:var(--muted)">
        <strong>Note:</strong> This creates a placeholder panel. In a full system, this would send to an AI API.
      </div>
    </div>
  `;
  
  $('#scroll').appendChild(col);
  
  // Bind actions
  col.querySelector('.col-btn.close').onclick=()=>{
    col.classList.add('removing');
    setTimeout(()=>{col.remove();updatePanelCount();},250);
  };
  col.querySelector('.column-tab').onclick=()=>col.classList.toggle('collapsed');
  
  col.querySelector('.prompt-copy').onclick=()=>{
    const prompt='CONTEXT:\\n'+contextText+'\\n\\nPROMPT:\\n'+col.querySelector('.prompt-input').value;
    copyText(prompt);
    toast('Prompt copied!','success');
  };
  
  col.querySelector('.prompt-generate').onclick=()=>{
    const promptText=col.querySelector('.prompt-input').value;
    if(promptText.length<3){toast('Enter a prompt','error');return;}
    
    // Create response panel (placeholder - in real system this would call API)
    const response='[Generated response would appear here]\\n\\nBased on context and prompt:\\n\\n'+promptText.slice(0,100)+'...\\n\\n(In a production system, this would connect to an AI API like Claude, GPT, etc.)';
    
    addColumn('witness','RESPONSE',`Generated`,`
      <div class="unit" data-text="${encodeURIComponent(response)}">
        <button class="copy-btn">COPY</button>
        <div class="unit-header">
          <div class="unit-id">GENERATED</div>
          <div class="unit-badge">${response.split('\\n').length} lines</div>
        </div>
        ${formatWithLines(response,'witness')}
      </div>
    `,colorIdx);
    bindLastPanelCopy();
    toast('Response panel created!','success');
  };
  
  updatePanelCount();
  setTimeout(()=>{
    col.classList.remove('new');
    col.querySelector('.prompt-input').focus();
    $('#scroll').scrollLeft=$('#scroll').scrollWidth;
  },50);
}

// ============ DIFF MODE ============
let diffState={active:false,source:null,target:null,diffs:[],currentIdx:0};

function startDiffSelection(sourceCol){
  toast('Click another panel to compare','');
  diffState.source=sourceCol;
  sourceCol.classList.add('diff-source');
  
  // One-time click handler for target selection
  const handler=e=>{
    const targetCol=e.target.closest('.column');
    if(targetCol&&targetCol!==sourceCol&&!targetCol.classList.contains('control-panel')&&targetCol.dataset.type!=='cases'){
      runDiff(sourceCol,targetCol);
    }
    document.removeEventListener('click',handler);
    sourceCol.classList.remove('diff-source');
  };
  setTimeout(()=>document.addEventListener('click',handler),100);
}

function runDiff(sourceCol,targetCol){
  diffState.active=true;
  diffState.source=sourceCol;
  diffState.target=targetCol;
  diffState.diffs=[];
  diffState.currentIdx=0;
  
  sourceCol.classList.add('diff-source');
  targetCol.classList.add('diff-target');
  
  // Get text from both panels
  const sourceLines=[...sourceCol.querySelectorAll('.text-line')].map(l=>l.querySelector('.line-text')?.textContent||'');
  const targetLines=[...targetCol.querySelectorAll('.text-line')].map(l=>l.querySelector('.line-text')?.textContent||'');
  
  // Simple line-by-line diff
  const maxLen=Math.max(sourceLines.length,targetLines.length);
  const sourceDom=sourceCol.querySelectorAll('.text-line');
  const targetDom=targetCol.querySelectorAll('.text-line');
  
  for(let i=0;i<maxLen;i++){
    const srcLine=sourceLines[i]||'';
    const tgtLine=targetLines[i]||'';
    
    if(i>=sourceLines.length){
      // Added in target
      if(targetDom[i]){
        targetDom[i].classList.add('diff-added');
        diffState.diffs.push({type:'added',line:targetDom[i]});
      }
    }else if(i>=targetLines.length){
      // Removed from source
      if(sourceDom[i]){
        sourceDom[i].classList.add('diff-removed');
        diffState.diffs.push({type:'removed',line:sourceDom[i]});
      }
    }else if(srcLine!==tgtLine){
      // Changed
      if(sourceDom[i])sourceDom[i].classList.add('diff-changed');
      if(targetDom[i])targetDom[i].classList.add('diff-changed');
      diffState.diffs.push({type:'changed',source:sourceDom[i],target:targetDom[i]});
    }
  }
  
  // Show diff toolbar
  $('#diff-toolbar').classList.add('visible');
  $('#diff-count').textContent=`${diffState.diffs.length} difference${diffState.diffs.length!==1?'s':''}`;
  
  if(diffState.diffs.length>0){
    scrollToDiff(0);
  }else{
    toast('No differences found!','success');
  }
}

function scrollToDiff(idx){
  if(idx<0||idx>=diffState.diffs.length)return;
  diffState.currentIdx=idx;
  
  const diff=diffState.diffs[idx];
  const line=diff.line||diff.target||diff.source;
  if(line){
    line.scrollIntoView({behavior:'smooth',block:'center'});
    // Flash highlight
    line.style.transition='background .2s';
    line.style.background='rgba(212,168,83,.4)';
    setTimeout(()=>{line.style.background='';},500);
  }
  
  $('#diff-count').textContent=`${idx+1}/${diffState.diffs.length} differences`;
}

function exitDiff(){
  diffState.active=false;
  diffState.source?.classList.remove('diff-source');
  diffState.target?.classList.remove('diff-target');
  
  // Clear all diff highlights
  document.querySelectorAll('.diff-added,.diff-removed,.diff-changed').forEach(el=>{
    el.classList.remove('diff-added','diff-removed','diff-changed');
  });
  
  $('#diff-toolbar').classList.remove('visible');
  diffState={active:false,source:null,target:null,diffs:[],currentIdx:0};
}

$('#diff-prev')?.addEventListener('click',()=>scrollToDiff(diffState.currentIdx-1));
$('#diff-next')?.addEventListener('click',()=>scrollToDiff(diffState.currentIdx+1));
$('#diff-exit')?.addEventListener('click',exitDiff);

// Keyboard navigation for diff
document.addEventListener('keydown',e=>{
  if(diffState.active){
    if(e.key==='ArrowUp'||e.key==='k'){scrollToDiff(diffState.currentIdx-1);e.preventDefault();}
    if(e.key==='ArrowDown'||e.key==='j'){scrollToDiff(diffState.currentIdx+1);e.preventDefault();}
    if(e.key==='Escape'){exitDiff();}
  }
});

function selectCase(id){
  state.activeCase=id;
  state.selectedText='';
  state.selectedUnit=null;
  document.querySelectorAll('[data-type="cases"] .unit').forEach(u=>u.classList.remove('active'));
  const unit=document.querySelector(`[data-type="cases"] [data-id="${id}"]`);
  if(unit)unit.classList.add('active');
  
  const c=state.cases.get(id);
  if(!c)return;
  
  removeColumnsAfter('cases');
  updateBreadcrumb();
  
  // Add prompt column
  addColumn('prompt','PROMPT',c.id,`
    <div class="unit" data-text="${encodeURIComponent(c.prompt)}">
      <button class="copy-btn">COPY</button>
      <div class="unit-header"><div class="unit-id">STAMPED ${c.id}</div></div>
      ${formatWithLines(c.prompt,'prompt')}
    </div>
  `,0);
  
  // Add one column per witness (source) with different colors
  c.witnesses.forEach((w,i)=>{
    const colorIdx=(i%6)+1;
    addColumn('witness',w.source,`Response ${i+1} of ${c.witnesses.length}`,`
      <div class="unit" data-text="${encodeURIComponent(w.text)}" data-idx="${i}">
        <button class="copy-btn">COPY</button>
        <div class="unit-header">
          <div class="unit-id">SOURCE: ${esc(w.fname)}</div>
          <div class="unit-badge">${w.text.split('\n').length} lines</div>
        </div>
        ${formatWithLines(w.text,'witness')}
      </div>
    `,colorIdx);
  });
  
  // Bind copy buttons and selection
  document.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const unit=btn.closest('.unit');
      const txt=decodeURIComponent(unit.dataset.text||'');
      copyText(txt);
    };
  });
  document.querySelectorAll('.column[data-type="prompt"] .unit, .column[data-type="witness"] .unit').forEach(u=>{
    u.onclick=()=>selectUnit(u);
    u.ondblclick=()=>{const txt=decodeURIComponent(u.dataset.text||'');copyText(txt);};
  });
  
  // Line click handlers with multi-select
  document.querySelectorAll('.text-line').forEach(line=>{
    const checkbox=line.querySelector('.line-select');
    if(checkbox){
      checkbox.onclick=e=>{
        e.stopPropagation();
        toggleLineSelection(line,e);
      };
    }
    line.onclick=e=>{
      e.stopPropagation();
      // If clicking the checkbox area, toggle selection
      if(e.target.classList.contains('line-select')){
        toggleLineSelection(line,e);
      }else{
        // Highlight for reading
        document.querySelectorAll('.text-line.highlight').forEach(l=>l.classList.remove('highlight'));
        line.classList.add('highlight');
      }
    };
  });
  
  // Clear selection when switching cases
  clearSelection();
}

function addColumn(type,title,subtitle,content,colorIdx=0,sourceData=null){
  state.colIndex++;
  const col=document.createElement('div');
  col.className='column new';
  col.dataset.type=type;
  col.dataset.index=state.colIndex;
  if(colorIdx)col.dataset.color=colorIdx;
  if(sourceData)col.dataset.source=JSON.stringify(sourceData);
  
  col.innerHTML=`
    <div class="column-tab"><div class="column-tab-dot"></div>${title.slice(0,12).toUpperCase()}</div>
    <div class="column-header">
      <div class="column-info">
        <div class="column-dot"></div>
        <div><div class="column-title">${title.toUpperCase()}</div><div class="column-subtitle">${subtitle}</div></div>
      </div>
      <div class="column-actions">
        <button class="col-btn copy" title="Copy Panel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        </button>
        <button class="col-btn" title="Duplicate Panel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="8" y="8" width="12" height="12" rx="2"/><path d="M16 8V6a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2h2"/></svg>
        </button>
        <button class="col-btn" title="Collapse">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <button class="col-btn close" title="Close Panel">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
    <div class="column-toolbar">
      <button class="toolbar-btn" data-action="copy-all">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy All
      </button>
      <button class="toolbar-btn" data-action="export">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        Export
      </button>
      <div class="toolbar-sep"></div>
      <button class="toolbar-btn" data-action="scroll-top">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
        Top
      </button>
    </div>
    <div class="column-content">${content}</div>
  `;
  
  // Bind column actions
  const copyBtn=col.querySelector('.col-btn.copy');
  const duplicateBtn=col.querySelectorAll('.col-btn')[1];
  const collapseBtn=col.querySelectorAll('.col-btn')[2];
  const closeBtn=col.querySelector('.col-btn.close');
  const tab=col.querySelector('.column-tab');
  
  copyBtn.onclick=e=>{
    e.stopPropagation();
    const unit=col.querySelector('.unit[data-text]');
    if(unit){
      copyWithFeedback(decodeURIComponent(unit.dataset.text),copyBtn);
    }
  };
  
  duplicateBtn.onclick=e=>{
    e.stopPropagation();
    const unit=col.querySelector('.unit[data-text]');
    if(unit){
      const newColorIdx=(state.colIndex%6)+1;
      addColumn(type,title+' (copy)',subtitle,col.querySelector('.column-content').innerHTML,newColorIdx);
      toast('Panel duplicated','success');
    }
  };
  
  collapseBtn.onclick=()=>col.classList.toggle('collapsed');
  closeBtn.onclick=()=>{
    col.classList.add('removing');
    setTimeout(()=>{col.remove();updatePanelCount();},250);
  };
  tab.onclick=()=>col.classList.toggle('collapsed');
  
  // Toolbar actions
  col.querySelectorAll('.toolbar-btn').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const action=btn.dataset.action;
      if(action==='copy-all'){
        const unit=col.querySelector('.unit[data-text]');
        if(unit)copyWithFeedback(decodeURIComponent(unit.dataset.text),btn);
      }else if(action==='export'){
        const unit=col.querySelector('.unit[data-text]');
        if(unit){
          const txt=decodeURIComponent(unit.dataset.text);
          const blob=new Blob([txt],{type:'text/plain'});
          const a=document.createElement('a');
          a.href=URL.createObjectURL(blob);
          a.download=`panel-${state.colIndex}.txt`;
          a.click();
          toast('Exported!','success');
        }
      }else if(action==='scroll-top'){
        col.querySelector('.column-content').scrollTo({top:0,behavior:'smooth'});
      }
    };
  });
  
  $('#scroll').appendChild(col);
  updatePanelCount();
  
  setTimeout(()=>{
    col.classList.remove('new');
    $('#scroll').scrollLeft=$('#scroll').scrollWidth;
  },50);
}

function updatePanelCount(){
  const count=document.querySelectorAll('.column').length;
  $('#panel-count').textContent=count;
}

function copyWithFeedback(text,btn){
  navigator.clipboard.writeText(text).then(()=>{
    if(btn){
      const origHTML=btn.innerHTML;
      btn.classList.add('active');
      btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
      setTimeout(()=>{btn.classList.remove('active');btn.innerHTML=origHTML;},1200);
    }
    toast('Copied to clipboard!','success');
  }).catch(()=>{
    const ta=document.createElement('textarea');
    ta.value=text;
    ta.style.cssText='position:fixed;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('Copied!');
  });
}

function removeColumnsAfter(type){
  document.querySelectorAll('.column').forEach(col=>{
    if(col.dataset.type!=='cases'&&col.dataset.type!==type)col.remove();
  });
}

function selectUnit(u){
  document.querySelectorAll('.unit.selected').forEach(x=>x.classList.remove('selected'));
  u.classList.add('selected');
  state.selectedUnit=u;
  state.selectedText=decodeURIComponent(u.dataset.text||'');
}

function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

async function loadFile(f){
  try{
    const txt=await f.text();
    const data=JSON.parse(txt);
    if(state.sources.find(s=>s.fname===f.name))return;
    const ex=extract(data,f.name);
    if(ex.pairs.length)state.sources.push(ex);
  }catch(e){console.error(e);}
}

async function autoLoad(){
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok)continue;
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.pairs.length)state.sources.push(ex);
    }catch(e){}
  }
  build();renderStats();renderCases();
  
  // Auto-select first case to get users started immediately
  setTimeout(()=>{
    const firstCase=[...state.cases.keys()][0];
    if(firstCase){
      selectCase(firstCase);
      toast('First case loaded - explore!','success');
    }
  },500);
}

// Events
$('#drop').onclick=()=>$('#files').click();
$('#drop').ondragover=e=>{e.preventDefault();$('#drop').classList.add('over');};
$('#drop').ondragleave=()=>$('#drop').classList.remove('over');
$('#drop').ondrop=async e=>{
  e.preventDefault();$('#drop').classList.remove('over');
  for(const f of e.dataTransfer.files)await loadFile(f);
  build();renderStats();renderCases();
};
$('#files').onchange=async e=>{
  for(const f of e.target.files)await loadFile(f);
  build();renderStats();renderCases();
};

// Collapse/Expand all
$('#collapse-all').onclick=()=>document.querySelectorAll('.column').forEach(c=>c.classList.add('collapsed'));
$('#expand-all').onclick=()=>document.querySelectorAll('.column').forEach(c=>c.classList.remove('collapsed'));

// Add panel - now creates inline control panel column
$('#add-panel').onclick=()=>toggleControlPanel();
$('#modal-close').onclick=()=>closeAddModal();
$('#modal-cancel').onclick=()=>closeAddModal();
$('#add-modal').onclick=e=>{if(e.target===$('#add-modal'))closeAddModal();};

// Control Panel as Column (WYSIWYG approach)
function toggleControlPanel(){
  // Check if control panel already exists
  const existing=document.querySelector('.column.control-panel');
  if(existing){
    existing.remove();
    updatePanelCount();
    return;
  }
  createControlPanel();
}

function createControlPanel(){
  const col=document.createElement('div');
  col.className='column control-panel new';
  col.dataset.type='control';
  
  col.innerHTML=`
    <div class="column-tab"><div class="column-tab-dot"></div>+ ADD</div>
    <div class="column-header">
      <div class="column-info">
        <div class="column-dot"></div>
        <div><div class="column-title">‚òÖ ADD PANEL</div></div>
      </div>
      <div class="column-actions">
        <button class="col-btn close" title="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
    <div class="control-tabs">
      <button class="control-tab active" data-tab="cases">Cases</button>
      <button class="control-tab" data-tab="sources">Sources</button>
      <button class="control-tab" data-tab="paste">Paste</button>
    </div>
    <div class="column-content" style="padding:0">
      <div class="control-content active" id="ctrl-cases">
        <div class="control-search"><input type="text" placeholder="Search cases..." id="ctrl-search-cases"></div>
        <div class="control-list" id="ctrl-case-list"></div>
      </div>
      <div class="control-content" id="ctrl-sources">
        <div class="control-search"><input type="text" placeholder="Search sources..." id="ctrl-search-sources"></div>
        <div class="control-list" id="ctrl-source-list"></div>
      </div>
      <div class="control-content" id="ctrl-paste">
        <div class="control-paste">
          <textarea id="ctrl-paste-text" placeholder="Paste or type text to compare..."></textarea>
          <input type="text" id="ctrl-paste-title" placeholder="Panel title (optional)">
          <button class="control-item-btn" id="ctrl-paste-add">+ Add as Panel</button>
        </div>
      </div>
    </div>
  `;
  
  // Insert after cases column
  const scroll=$('#scroll');
  const casesCol=scroll.querySelector('[data-type="cases"]');
  if(casesCol&&casesCol.nextSibling){
    scroll.insertBefore(col,casesCol.nextSibling);
  }else{
    scroll.appendChild(col);
  }
  
  // Bind close
  col.querySelector('.col-btn.close').onclick=()=>{
    col.classList.add('removing');
    setTimeout(()=>{col.remove();updatePanelCount();},250);
  };
  col.querySelector('.column-tab').onclick=()=>col.classList.toggle('collapsed');
  
  // Tab switching
  col.querySelectorAll('.control-tab').forEach(tab=>{
    tab.onclick=()=>{
      col.querySelectorAll('.control-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      col.querySelectorAll('.control-content').forEach(c=>c.classList.remove('active'));
      col.querySelector(`#ctrl-${tab.dataset.tab}`).classList.add('active');
    };
  });
  
  // Populate cases
  populateControlCases(col);
  populateControlSources(col);
  
  // Search handlers
  col.querySelector('#ctrl-search-cases').oninput=e=>{
    const q=e.target.value.toLowerCase();
    col.querySelectorAll('#ctrl-case-list .control-item').forEach(item=>{
      item.style.display=item.textContent.toLowerCase().includes(q)?'block':'none';
    });
  };
  col.querySelector('#ctrl-search-sources').oninput=e=>{
    const q=e.target.value.toLowerCase();
    col.querySelectorAll('#ctrl-source-list .control-item').forEach(item=>{
      item.style.display=item.textContent.toLowerCase().includes(q)?'block':'none';
    });
  };
  
  // Paste handler
  col.querySelector('#ctrl-paste-add').onclick=()=>{
    const text=col.querySelector('#ctrl-paste-text').value;
    const title=col.querySelector('#ctrl-paste-title').value||'Pasted';
    if(text.length<5){toast('Enter some text','error');return;}
    const colorIdx=(state.colIndex%6)+1;
    addColumn('witness',title,`${text.split('\\n').length} lines`,`
      <div class="unit" data-text="${encodeURIComponent(text)}">
        <button class="copy-btn">COPY</button>
        <div class="unit-header">
          <div class="unit-id">PASTED</div>
          <div class="unit-badge">${text.split('\\n').length} lines</div>
        </div>
        ${formatWithLines(text,'witness')}
      </div>
    `,colorIdx);
    bindLastPanelCopy();
    col.querySelector('#ctrl-paste-text').value='';
    col.querySelector('#ctrl-paste-title').value='';
    toast('Panel added!','success');
  };
  
  updatePanelCount();
  setTimeout(()=>col.classList.remove('new'),50);
}

function populateControlCases(col){
  let html='';
  let i=0;
  for(const[k,c]of state.cases){
    i++;
    const title=c.prompt.split('\\n').find(l=>l.trim())||'Untitled';
    html+=`<div class="control-item" data-case="${k}">
      <div class="control-item-title">${esc(title.slice(0,50))}</div>
      <div class="control-item-meta">${c.witnesses.length} witness${c.witnesses.length>1?'es':''}</div>
      <button class="control-item-btn">+ Add Case</button>
    </div>`;
  }
  col.querySelector('#ctrl-case-list').innerHTML=html||'<div style="color:var(--muted);padding:16px;text-align:center">No cases loaded</div>';
  
  col.querySelectorAll('#ctrl-case-list .control-item-btn').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const item=btn.closest('.control-item');
      const caseId=item.dataset.case;
      const c=state.cases.get(caseId);
      if(!c)return;
      selectCase(caseId);
      toast('Case loaded!','success');
    };
  });
}

function populateControlSources(col){
  const sourceCounts=new Map();
  const sourceWitnesses=new Map();
  for(const[k,c]of state.cases){
    c.witnesses.forEach(w=>{
      sourceCounts.set(w.source,(sourceCounts.get(w.source)||0)+1);
      if(!sourceWitnesses.has(w.source))sourceWitnesses.set(w.source,[]);
      sourceWitnesses.get(w.source).push({caseId:k,witness:w,caseTitle:c.prompt.split('\\n')[0]?.slice(0,40)||'Untitled'});
    });
  }
  
  let html='';
  for(const[source,count]of sourceCounts){
    html+=`<div class="control-item" data-source="${esc(source)}">
      <div class="control-item-title">${esc(source)}</div>
      <div class="control-item-meta">${count} witnesses</div>
      <div class="control-witnesses" style="display:none;margin-top:8px;border-top:1px solid var(--border);padding-top:8px"></div>
    </div>`;
  }
  col.querySelector('#ctrl-source-list').innerHTML=html||'<div style="color:var(--muted);padding:16px">No sources</div>';
  
  // Click to expand witnesses
  col.querySelectorAll('#ctrl-source-list .control-item').forEach(item=>{
    item.onclick=()=>{
      const witnessDiv=item.querySelector('.control-witnesses');
      if(witnessDiv.style.display==='none'){
        const source=item.dataset.source;
        const witnesses=sourceWitnesses.get(source)||[];
        witnessDiv.innerHTML=witnesses.map((w,i)=>`
          <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <div style="flex:1;min-width:0">
              <div style="font-size:10px;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(w.caseTitle)}</div>
              <div style="font-size:9px;color:var(--muted)">${w.witness.text.split('\\n').length} lines</div>
            </div>
            <button class="control-item-btn" style="width:auto;margin:0;padding:6px 10px" data-idx="${i}">+ Add</button>
          </div>
        `).join('');
        witnessDiv.style.display='block';
        
        // Bind add buttons
        witnessDiv.querySelectorAll('button').forEach((btn,idx)=>{
          btn.onclick=e=>{
            e.stopPropagation();
            const w=witnesses[idx];
            const colorIdx=(state.colIndex%6)+1;
            addColumn('witness',w.witness.source,`From: ${w.caseTitle.slice(0,30)}`,`
              <div class="unit" data-text="${encodeURIComponent(w.witness.text)}">
                <button class="copy-btn">COPY</button>
                <div class="unit-header">
                  <div class="unit-id">SOURCE: ${esc(w.witness.fname)}</div>
                  <div class="unit-badge">${w.witness.text.split('\\n').length} lines</div>
                </div>
                ${formatWithLines(w.witness.text,'witness')}
              </div>
            `,colorIdx);
            bindLastPanelCopy();
            toast('Witness added!','success');
          };
        });
      }else{
        witnessDiv.style.display='none';
      }
    };
  });
}

let modalState={tab:'cases',selectedCase:null,selectedWitness:null,pasteText:''};

// Tab switching
$$('.modal-tab').forEach(tab=>{
  tab.onclick=()=>{
    $$('.modal-tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    modalState.tab=tab.dataset.tab;
    $$('.modal-tab-content').forEach(c=>c.style.display='none');
    $(`#tab-${tab.dataset.tab}`).style.display='block';
    updateModalFooter();
  };
});

// Modal search
$('#modal-search').oninput=e=>{
  const q=e.target.value.toLowerCase();
  filterModalItems(q);
};

function filterModalItems(q){
  if(modalState.tab==='cases'){
    $$('#case-list .witness-item').forEach(item=>{
      const text=item.textContent.toLowerCase();
      item.style.display=text.includes(q)?'flex':'none';
    });
  }else if(modalState.tab==='witnesses'){
    $$('#witness-list .witness-item').forEach(item=>{
      const text=item.textContent.toLowerCase();
      item.style.display=text.includes(q)?'flex':'none';
    });
  }
}

function updateModalFooter(){
  const info=$('#modal-info');
  const addBtn=$('#modal-add');
  if(modalState.tab==='paste'){
    const text=$('#paste-text')?.value||'';
    if(text.length>10){
      info.textContent=`${text.split('\\n').length} lines ready`;
      addBtn.style.display='block';
    }else{
      info.textContent='Enter text to add as panel';
      addBtn.style.display='none';
    }
  }else{
    info.textContent=`${state.cases.size} cases ‚Ä¢ ${state.sources.length} sources`;
    addBtn.style.display='none';
  }
}

// Paste tab handlers
$('#paste-text')?.addEventListener('input',updateModalFooter);
$('#modal-add')?.addEventListener('click',()=>{
  const text=$('#paste-text')?.value||'';
  const title=$('#paste-title')?.value||'Pasted Text';
  if(text.length<5){toast('Enter some text first','error');return;}
  const colorIdx=(state.colIndex%6)+1;
  addColumn('witness',title,`${text.split('\\n').length} lines`,`
    <div class="unit" data-text="${encodeURIComponent(text)}">
      <button class="copy-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>COPY</button>
      <div class="unit-header">
        <div class="unit-id">PASTED</div>
        <div class="unit-badge">${text.split('\\n').length} lines</div>
      </div>
      ${formatWithLines(text,'witness')}
    </div>
  `,colorIdx);
  bindLastPanelCopy();
  closeAddModal();
  toast('Panel added!','success');
});

function bindLastPanelCopy(){
  const newUnit=document.querySelector('.column:last-child .unit');
  if(newUnit){
    const copyBtn=newUnit.querySelector('.copy-btn');
    if(copyBtn){
      copyBtn.onclick=e=>{
        e.stopPropagation();
        copyWithFeedback(decodeURIComponent(newUnit.dataset.text||''),copyBtn);
      };
    }
  }
}

function openAddModal(){
  // Reset state
  modalState={tab:'cases',selectedCase:null,selectedWitness:null};
  $$('.modal-tab').forEach(t=>t.classList.remove('active'));
  $('.modal-tab[data-tab="cases"]').classList.add('active');
  $$('.modal-tab-content').forEach(c=>c.style.display='none');
  $('#tab-cases').style.display='block';
  $('#modal-search').value='';
  $('#paste-text').value='';
  $('#paste-title').value='';
  
  // Build cases list
  let caseHtml='';
  let i=0;
  for(const[k,c]of state.cases){
    i++;
    const title=c.prompt.split('\\n').find(l=>l.trim())||'Untitled';
    caseHtml+=`<div class="witness-item" data-case="${k}">
      <div class="witness-item-info">
        <div class="witness-item-title">${esc(title.slice(0,60))}</div>
        <div class="witness-item-meta">${c.witnesses.length} witness${c.witnesses.length>1?'es':''}</div>
      </div>
      <button class="witness-item-add">+ ADD</button>
    </div>`;
  }
  $('#case-list').innerHTML=caseHtml||'<div style="color:var(--muted);padding:16px;text-align:center">No cases loaded</div>';
  
  // Bind case add buttons
  $$('#case-list .witness-item-add').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const item=btn.closest('.witness-item');
      const caseId=item.dataset.case;
      const c=state.cases.get(caseId);
      if(!c)return;
      const colorIdx=(state.colIndex%6)+1;
      addColumn('prompt','CASE',c.id,`
        <div class="unit" data-text="${encodeURIComponent(c.prompt)}">
          <button class="copy-btn">COPY</button>
          <div class="unit-header"><div class="unit-id">CASE ${c.id}</div></div>
          ${formatWithLines(c.prompt,'prompt')}
        </div>
      `,colorIdx);
      bindLastPanelCopy();
      closeAddModal();
      toast('Case added!','success');
    };
  });
  
  // Build source grid
  let sourceHtml='';
  const sourceCounts=new Map();
  for(const[k,c]of state.cases){
    c.witnesses.forEach(w=>{
      sourceCounts.set(w.source,(sourceCounts.get(w.source)||0)+1);
    });
  }
  for(const[source,count]of sourceCounts){
    sourceHtml+=`<button class="source-btn" data-source="${esc(source)}">
      <div class="source-btn-name">${esc(source)}</div>
      <div class="source-btn-count">${count} witnesses</div>
      <div class="source-btn-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg></div>
    </button>`;
  }
  $('#source-grid').innerHTML=sourceHtml;
  
  // Bind source buttons
  $$('.source-btn').forEach(btn=>{
    btn.onclick=()=>{
      $$('.source-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      selectSource(btn.dataset.source);
    };
  });
  
  $('#witness-section').style.display='none';
  updateModalFooter();
  $('#add-modal').classList.add('open');
}

function closeAddModal(){
  $('#add-modal').classList.remove('open');
}

function selectSource(sourceName){
  // Find all witnesses from this source
  let witnesses=[];
  for(const[k,c]of state.cases){
    c.witnesses.forEach((w,i)=>{
      if(w.source===sourceName){
        witnesses.push({
          caseId:k,
          title:c.prompt.split('\\n')[0]?.slice(0,60)||'Untitled',
          witness:w,
          idx:i
        });
      }
    });
  }
  
  let html='';
  witnesses.forEach((w,i)=>{
    html+=`<div class="witness-item" data-idx="${i}">
      <div class="witness-item-info">
        <div class="witness-item-title">${esc(w.title)}</div>
        <div class="witness-item-meta">${w.witness.text.split('\\n').length} lines ‚Ä¢ ${esc(w.witness.fname)}</div>
      </div>
      <button class="witness-item-add">+ ADD</button>
    </div>`;
  });
  
  $('#witness-list').innerHTML=html||'<div style="color:var(--muted);padding:16px">No witnesses from this source</div>';
  $('#witness-section').style.display='block';
  
  // Bind add buttons
  $$('#witness-list .witness-item-add').forEach((btn,i)=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const w=witnesses[i];
      const colorIdx=(state.colIndex%6)+1;
      addColumn('witness',w.witness.source,`From: ${w.title.slice(0,30)}`,`
        <div class="unit" data-text="${encodeURIComponent(w.witness.text)}">
          <button class="copy-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>COPY</button>
          <div class="unit-header">
            <div class="unit-id">SOURCE: ${esc(w.witness.fname)}</div>
            <div class="unit-badge">${w.witness.text.split('\\n').length} lines</div>
          </div>
          ${formatWithLines(w.witness.text,'witness')}
        </div>
      `,colorIdx,{source:w.witness.source,caseId:w.caseId});
      bindLastPanelCopy();
      closeAddModal();
      toast('Witness added!','success');
    };
  });
}

// Intro toggle
$('#intro-toggle').onclick=()=>{
  const intro=$('#intro');
  const hidden=intro.style.display==='none';
  intro.style.display=hidden?'block':'none';
  $('#intro-toggle').textContent=hidden?'[HIDE INTRO]':'[SHOW INTRO]';
};

// Keyboard shortcuts
document.onkeydown=e=>{
  if(e.key==='c'&&!e.ctrlKey&&!e.metaKey&&state.selectedText){copyText(state.selectedText);e.preventDefault();}
  if(e.key==='h'&&!e.ctrlKey&&!e.metaKey){$('#intro-toggle').click();e.preventDefault();}
  if(e.key==='ArrowRight'){$('#scroll').scrollBy({left:300,behavior:'smooth'});}
  if(e.key==='ArrowLeft'){$('#scroll').scrollBy({left:-300,behavior:'smooth'});}
};

// Long press for mobile copy
let pressTimer;
document.addEventListener('touchstart',e=>{
  const unit=e.target.closest('.unit[data-text]');
  if(!unit)return;
  pressTimer=setTimeout(()=>{
    const txt=decodeURIComponent(unit.dataset.text||'');
    copyText(txt);
  },600);
});
document.addEventListener('touchend',()=>clearTimeout(pressTimer));
document.addEventListener('touchmove',()=>clearTimeout(pressTimer));

// Onboarding
const onboarding=$('#onboarding');
const hasSeenOnboard=localStorage.getItem('compare-onboarded');
if(hasSeenOnboard){
  onboarding.classList.add('hidden');
}

$('#onboard-start').onclick=()=>{
  if($('#onboard-remember').checked){
    localStorage.setItem('compare-onboarded','true');
  }
  onboarding.classList.add('hidden');
};

// Help panel
const helpPanel=$('#help-panel');
$('#help-close').onclick=()=>helpPanel.classList.remove('open');

function toggleHelp(){
  helpPanel.classList.toggle('open');
}

// Mobile bar handlers
$('#mob-add')?.addEventListener('click',()=>openAddModal());
$('#mob-search')?.addEventListener('click',()=>{
  searchInput.focus();
  searchInput.scrollIntoView({behavior:'smooth'});
});
$('#mob-help')?.addEventListener('click',toggleHelp);
$('#mob-copy')?.addEventListener('click',()=>{
  if(state.selectedText){
    copyText(state.selectedText);
  }else{
    // Copy first visible panel
    const firstUnit=document.querySelector('.column:not(.collapsed):not([data-type="cases"]) .unit[data-text]');
    if(firstUnit){
      copyText(decodeURIComponent(firstUnit.dataset.text||''));
    }else{
      toast('Select a panel first','error');
    }
  }
});

// Update keyboard shortcuts to include help toggle
const origKeydown=document.onkeydown;
document.onkeydown=e=>{
  if(e.key==='h'&&!e.ctrlKey&&!e.metaKey){
    toggleHelp();
    e.preventDefault();
    return;
  }
  if(e.key==='Escape'){
    helpPanel.classList.remove('open');
  }
  if(origKeydown)origKeydown(e);
};

// Add help button to header actions
const headerActions=document.querySelector('.header-actions');
if(headerActions){
  const helpBtn=document.createElement('button');
  helpBtn.className='icon-btn';
  helpBtn.id='help-toggle';
  helpBtn.title='Help';
  helpBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3M12 17h.01"/></svg>';
  helpBtn.onclick=toggleHelp;
  headerActions.insertBefore(helpBtn,headerActions.firstChild);
}

autoLoad();
updatePanelCount();
</script>
</body>
</html>
