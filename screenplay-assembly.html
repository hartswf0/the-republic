<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>THE REPUBLIC — Screenplay Assembly</title>
<link rel="icon" type="image/svg+xml" href="favicon-screenplay.svg">
<style>
:root{
  --bg:#0a0a0a;--bg2:#111;--panel:#161616;
  --fg:#e8e8e8;--fg-dim:#888;--fg-muted:#555;
  --accent:#d4a853;--scene:#f43f5e;
  --char1:#60a5fa;--char2:#34d399;--char3:#f472b6;--char4:#a78bfa;--char5:#fbbf24;--char6:#22d3ee;
  --border:#2a2a2a;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:'Courier New',monospace;background:var(--bg);color:var(--fg);overflow:hidden}

/* Layout */
.app{display:flex;height:100vh}

/* Navigator Panel - expanded sidebar */
.navigator{width:240px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.nav-header{padding:16px;border-bottom:1px solid var(--border)}
.nav-title{font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:.15em;margin-bottom:12px}
.nav-progress{height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:8px}
.nav-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--scene));width:0%;transition:width .2s}
.nav-stats{display:flex;gap:16px;font-size:10px;color:var(--fg-dim)}
.nav-stats b{color:var(--fg)}

/* Scroll Controls */
.scroll-controls{display:flex;gap:4px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg2)}
.scroll-btn{flex:1;padding:8px;background:var(--panel);border:1px solid var(--border);color:var(--fg-dim);font:inherit;font-size:10px;cursor:pointer;border-radius:4px;transition:all .15s}
.scroll-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(212,168,83,.05)}
.scroll-btn:active{transform:scale(.97)}
.scroll-btn svg{width:14px;height:14px;display:block;margin:0 auto}

/* Scene Jump Select */
.scene-select{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);color:var(--fg);font:inherit;font-size:11px;border-radius:4px;margin-top:8px;cursor:pointer}
.scene-select:focus{outline:none;border-color:var(--accent)}

/* Section List */
.nav-sections{flex:1;overflow-y:auto;padding:8px}
.nav-sections::-webkit-scrollbar{width:4px}
.nav-sections::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.nav-section{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-bottom:4px;font-size:11px;cursor:pointer;border-radius:6px;border-left:3px solid transparent;transition:all .15s}
.nav-section:hover{background:rgba(255,255,255,.03)}
.nav-section.active{background:rgba(212,168,83,.08);border-left-color:var(--accent)}
.nav-section.scene{color:var(--scene);font-weight:600}
.nav-section.scene::before{content:'◆';font-size:8px;color:var(--scene)}
.nav-section.witness{color:var(--fg-dim);padding-left:24px;font-size:10px}
.nav-section.witness::before{content:'›';color:var(--char2)}
.nav-section-text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Visual Minimap */
.minimap-visual{height:140px;border-top:1px solid var(--border);position:relative;background:var(--bg)}
.minimap-track{position:absolute;inset:8px;border-radius:4px;overflow:hidden}
.minimap-track canvas{width:100%;height:100%;display:block}
.minimap-viewport{position:absolute;left:8px;right:8px;background:rgba(212,168,83,.15);border:1px solid var(--accent);border-radius:3px;pointer-events:none;box-shadow:0 0 12px rgba(212,168,83,.2)}
.minimap-label{position:absolute;bottom:4px;right:12px;font-size:8px;color:var(--fg-muted);text-transform:uppercase;letter-spacing:.05em}

/* Main Content */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.header{height:52px;background:linear-gradient(180deg,#0f0f0f,#080808);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:16px}
.logo{font-weight:bold;font-size:13px;color:var(--accent);display:flex;align-items:center;gap:8px}
.logo svg{width:18px;height:18px}
.search-box{flex:1;max-width:320px;position:relative}
.search-input{width:100%;padding:10px 14px 10px 36px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--fg);font:inherit;font-size:12px}
.search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(212,168,83,.1)}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--fg-muted)}
.search-icon svg{width:14px;height:14px}
.header-actions{display:flex;gap:8px}
.btn{padding:10px 16px;background:var(--panel);border:1px solid var(--border);color:var(--fg-dim);font:inherit;font-size:10px;cursor:pointer;border-radius:6px;text-transform:uppercase;letter-spacing:.05em;transition:all .15s}
.btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(212,168,83,.05)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#000}
.btn-primary:hover{background:#e8bc6a}

/* Screenplay Content */
.content{flex:1;overflow-y:auto;padding:30px 50px 100px;line-height:1.8;font-size:13px;scroll-behavior:smooth}
.content::-webkit-scrollbar{width:10px}
.content::-webkit-scrollbar-track{background:var(--bg2)}
.content::-webkit-scrollbar-thumb{background:var(--border);border-radius:5px;border:2px solid var(--bg2)}
.content::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* Floating scroll indicator */
.scroll-indicator{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:8px;z-index:100}
.scroll-fab{width:44px;height:44px;border-radius:50%;background:var(--panel);border:1px solid var(--border);color:var(--fg-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.scroll-fab:hover{border-color:var(--accent);color:var(--accent);transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.5)}
.scroll-fab svg{width:18px;height:18px}
.scroll-position{width:44px;height:44px;border-radius:50%;background:var(--accent);color:#000;font-size:11px;font-weight:bold;display:flex;align-items:center;justify-content:center}

/* Line Types */
.line{padding:2px 0;position:relative}
.line-num{position:absolute;left:-36px;width:30px;text-align:right;font-size:9px;color:var(--fg-muted);opacity:.5}
.blank{height:20px}
.title{text-align:center;font-size:20px;font-weight:bold;letter-spacing:.15em;color:var(--accent);margin:40px 0 10px}
.subtitle{text-align:center;font-size:14px;color:var(--fg-dim)}
.scene-heading{color:var(--scene);font-weight:bold;text-transform:uppercase;margin:30px 0 15px;padding:8px;background:rgba(244,63,94,.05);border-left:3px solid var(--scene)}
.action{color:var(--fg-dim);margin:10px 0}
.character{text-align:center;text-transform:uppercase;font-weight:bold;margin:20px 0 5px;padding-left:120px}
.dialogue{margin:0 auto;max-width:400px;padding-left:80px}
.parenthetical{text-align:center;font-style:italic;color:var(--fg-dim);padding-left:100px}
.transition{text-align:right;text-transform:uppercase;margin:20px 0}
.witness-header{font-size:10px;color:var(--char2);margin:25px 0 10px;padding:5px 10px;background:rgba(52,211,153,.05);border-left:2px solid var(--char2)}
.page-break{border-top:1px dashed var(--border);margin:30px 0;position:relative}
.page-break::after{content:attr(data-page);position:absolute;top:-10px;right:0;font-size:9px;color:var(--fg-muted);background:var(--bg);padding:0 8px}

/* Character Colors */
.char-WATNEY{color:var(--char1)}
.char-HARV,.char-H-A-R-V{color:var(--char2)}
.char-WALT,.char-W-A-L-T{color:var(--char3)}
.char-MARTINEZ{color:var(--char4)}
.char-LEWIS{color:var(--char5)}
.char-default{color:var(--fg)}

/* Mobile */
@media(max-width:900px){
  .navigator{width:200px}
  .content{padding:24px 30px 80px}
}
@media(max-width:768px){
  .navigator{width:60px}
  .nav-header,.scroll-controls,.nav-section-text{display:none}
  .nav-section{justify-content:center;padding:8px}
  .nav-section::before{margin:0}
  .minimap-visual{height:200px}
  .content{padding:16px 20px 80px;font-size:12px}
  .dialogue{padding-left:20px;max-width:100%}
  .character{padding-left:20px}
  .parenthetical{padding-left:30px}
}
@media(max-width:500px){
  .navigator{display:none}
  .content{padding:12px 16px 80px}
  .scroll-indicator{bottom:16px;right:16px}
  .scroll-fab,.scroll-position{width:38px;height:38px}
}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;height:100%;color:var(--fg-muted)}
</style>
</head>
<body>
<div class="app">
  <aside class="navigator">
    <div class="nav-header">
      <div class="nav-title">★ Navigator</div>
      <div class="nav-progress"><div class="nav-progress-bar" id="progress"></div></div>
      <div class="nav-stats">
        <span>Scenes: <b id="stat-scenes">0</b></span>
        <span>Lines: <b id="stat-lines">0</b></span>
      </div>
      <select class="scene-select" id="scene-select">
        <option value="">Jump to scene...</option>
      </select>
    </div>
    <div class="scroll-controls">
      <button class="scroll-btn" id="scroll-top" title="Top">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/><line x1="12" y1="3" x2="12" y2="3"/></svg>
      </button>
      <button class="scroll-btn" id="scroll-up" title="Page Up">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
      </button>
      <button class="scroll-btn" id="scroll-down" title="Page Down">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
      </button>
      <button class="scroll-btn" id="scroll-bottom" title="Bottom">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/><line x1="12" y1="21" x2="12" y2="21"/></svg>
      </button>
    </div>
    <div class="nav-sections" id="sections"></div>
    <div class="minimap-visual" id="minimap-wrap">
      <div class="minimap-track"><canvas id="minimap"></canvas></div>
      <div class="minimap-viewport" id="viewport"></div>
      <div class="minimap-label">Document Map</div>
    </div>
  </aside>
  <main class="main">
    <header class="header">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12,2 15,9 22,9 16.5,14 18.5,21 12,17 5.5,21 7.5,14 2,9 9,9"/></svg>
        SCREENPLAY
      </div>
      <div class="search-box">
        <span class="search-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></span>
        <input type="text" class="search-input" id="search" placeholder="Search screenplay...">
      </div>
      <div class="header-actions">
        <button class="btn" id="export-btn">Export TXT</button>
      </div>
    </header>
    <div class="content" id="content">
      <div class="loading">Loading screenplay...</div>
    </div>
  </main>
  <div class="scroll-indicator">
    <button class="scroll-fab" id="fab-up" title="Scroll Up">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
    </button>
    <div class="scroll-position" id="scroll-pos">0%</div>
    <button class="scroll-fab" id="fab-down" title="Scroll Down">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const FILES=['ma-52.json','character-comp-52.json','world-prompt-52.json','matrix-editor-52.json','legos-cog-arch-52.json','legos-gpt-52.json','slugline-seq-52.json'];
const LINES_PER_PAGE=55;

const state={sources:[],scenes:[],elements:[],sections:[]};

// Character color mapping
const CHAR_COLORS=['char1','char2','char3','char4','char5','char6'];
const charColorMap=new Map();
let colorIdx=0;

function getCharColor(name){
  const key=name.toUpperCase().replace(/[^A-Z]/g,'');
  if(!charColorMap.has(key)){
    charColorMap.set(key,CHAR_COLORS[colorIdx%CHAR_COLORS.length]);
    colorIdx++;
  }
  return charColorMap.get(key);
}

function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function extract(data,fname){
  const pairs=[];
  const title=data.metadata?.title||fname.replace('.json','').replace(/-\d+$/,'').replace(/-/g,' ');
  if(data.messages&&Array.isArray(data.messages)){
    for(let i=0;i<data.messages.length;i++){
      const m=data.messages[i];
      if(m.role==='Prompt'&&m.say){
        let comp='';
        if(data.messages[i+1]?.role==='Response')comp=data.messages[i+1].say||'';
        if(comp)pairs.push({prompt:m.say,comp,source:title});
      }
    }
  }
  return{fname,title,pairs};
}

function buildScenes(){
  const map=new Map();
  for(const src of state.sources){
    for(const p of src.pairs){
      const key=p.prompt.slice(0,100);
      if(!map.has(key)){
        map.set(key,{prompt:p.prompt,title:p.prompt.split('\n')[0].slice(0,60),witnesses:[]});
      }
      map.get(key).witnesses.push({source:p.source,text:p.comp});
    }
  }
  state.scenes=Array.from(map.values());
}

function parseDialogue(text){
  const lines=text.split('\n');
  const result=[];
  let currentChar=null;
  
  for(const line of lines){
    const trimmed=line.trim();
    if(!trimmed)continue;
    
    // Detect character name (ALL CAPS at start of line, possibly with dashes like H.A.R.V.-R)
    const charMatch=trimmed.match(/^([A-Z][A-Z\.\-\s]{1,20})(?:\s|$)/);
    if(charMatch&&trimmed===charMatch[0].trim()){
      currentChar=charMatch[1].trim();
      result.push({type:'character',name:currentChar,color:getCharColor(currentChar)});
    }
    // Parenthetical
    else if(trimmed.startsWith('(')){
      result.push({type:'parenthetical',text:trimmed});
    }
    // Dialogue
    else if(currentChar){
      result.push({type:'dialogue',text:trimmed,char:currentChar,color:getCharColor(currentChar)});
    }
    // Action/description
    else{
      result.push({type:'action',text:trimmed});
    }
  }
  return result;
}

function buildElements(){
  state.elements=[];
  state.sections=[];
  let lineNum=0;
  let sceneNum=0;
  
  // Title
  state.elements.push({type:'title',text:'THE REPUBLIC'});
  state.elements.push({type:'subtitle',text:'Assembled Screenplay'});
  state.elements.push({type:'blank'});
  
  // Process each scene
  for(const scene of state.scenes){
    sceneNum++;
    const sceneTitle=`SCENE ${sceneNum}`;
    
    // Scene heading
    state.elements.push({type:'scene',text:sceneTitle,id:'scene-'+sceneNum});
    state.sections.push({type:'scene',text:sceneTitle,id:'scene-'+sceneNum,idx:state.elements.length-1});
    
    // Scene prompt as action
    state.elements.push({type:'action',text:scene.title});
    state.elements.push({type:'blank'});
    
    // Each witness
    scene.witnesses.forEach((w,wi)=>{
      const witnessId='w-'+sceneNum+'-'+wi;
      state.elements.push({type:'witness',text:`[${w.source}]`,id:witnessId});
      state.sections.push({type:'witness',text:w.source.slice(0,20),id:witnessId,idx:state.elements.length-1});
      
      // Parse dialogue
      const parsed=parseDialogue(w.text);
      for(const p of parsed){
        state.elements.push(p);
      }
      state.elements.push({type:'blank'});
    });
    
    // Page break every ~55 lines equivalent
    if(sceneNum%3===0){
      const pageNum=Math.floor(sceneNum/3)+1;
      state.elements.push({type:'page-break',page:pageNum});
    }
  }
  
  state.elements.push({type:'transition',text:'THE END'});
}

function render(filter=''){
  const content=$('#content');
  const q=filter.toLowerCase();
  
  let html='';
  let lineNum=0;
  
  for(const el of state.elements){
    lineNum++;
    const lineNumHtml=`<span class="line-num">${lineNum}</span>`;
    
    // Filter check
    if(q&&el.text&&!el.text.toLowerCase().includes(q))continue;
    
    switch(el.type){
      case 'title':
        html+=`<div class="line title" id="${el.id||''}">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'subtitle':
        html+=`<div class="line subtitle">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'scene':
        html+=`<div class="line scene-heading" id="${el.id}">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'action':
        html+=`<div class="line action">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'character':
        html+=`<div class="line character" style="color:var(--${el.color})">${lineNumHtml}${esc(el.name)}</div>`;
        break;
      case 'dialogue':
        html+=`<div class="line dialogue" style="color:var(--${el.color})">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'parenthetical':
        html+=`<div class="line parenthetical">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'transition':
        html+=`<div class="line transition">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'witness':
        html+=`<div class="line witness-header" id="${el.id}">${lineNumHtml}${esc(el.text)}</div>`;
        break;
      case 'page-break':
        html+=`<div class="page-break" data-page="Page ${el.page}"></div>`;
        break;
      case 'blank':
        html+=`<div class="blank"></div>`;
        break;
    }
  }
  
  content.innerHTML=html||'<div class="loading">No content matches your search.</div>';
}

function renderSections(){
  const el=$('#sections');
  const select=$('#scene-select');
  let html='';
  let selectHtml='<option value="">Jump to scene...</option>';
  
  for(const s of state.sections){
    const cls=s.type==='scene'?'scene':'witness';
    html+=`<div class="nav-section ${cls}" data-id="${s.id}"><span class="nav-section-text">${esc(s.text)}</span></div>`;
    if(s.type==='scene'){
      selectHtml+=`<option value="${s.id}">${esc(s.text)}</option>`;
    }
  }
  el.innerHTML=html;
  select.innerHTML=selectHtml;
  
  // Click handlers for sections
  el.querySelectorAll('.nav-section').forEach(sec=>{
    sec.onclick=()=>scrollToSection(sec.dataset.id);
  });
  
  // Select change handler
  select.onchange=e=>{
    if(e.target.value)scrollToSection(e.target.value);
    e.target.value='';
  };
}

function scrollToSection(id){
  const target=document.getElementById(id);
  if(target){
    target.scrollIntoView({behavior:'smooth',block:'start'});
    // Update active
    document.querySelectorAll('.nav-section').forEach(s=>s.classList.remove('active'));
    const sec=document.querySelector(`.nav-section[data-id="${id}"]`);
    if(sec)sec.classList.add('active');
  }
}

function renderMinimap(){
  const canvas=$('#minimap');
  const wrap=$('#minimap-wrap');
  const rect=wrap.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  
  canvas.width=rect.width*dpr;
  canvas.height=rect.height*dpr;
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  
  const lineH=rect.height/state.elements.length;
  
  state.elements.forEach((el,i)=>{
    const y=i*lineH;
    let color='#222';
    if(el.type==='scene')color='#f43f5e';
    else if(el.type==='witness')color='#34d399';
    else if(el.type==='character'||el.type==='dialogue')color='#60a5fa';
    else if(el.type==='action')color='#888';
    
    if(el.text){
      ctx.fillStyle=color;
      ctx.fillRect(2,y,Math.min(rect.width-4,el.text.length*0.5),Math.max(1,lineH));
    }
  });
}

function updateViewport(){
  const content=$('#content');
  const viewport=$('#viewport');
  const wrap=$('#minimap-wrap');
  const track=wrap.querySelector('.minimap-track');
  const wrapH=track.getBoundingClientRect().height;
  
  const maxScroll=content.scrollHeight-content.clientHeight;
  const scrollRatio=maxScroll>0?content.scrollTop/maxScroll:0;
  const viewRatio=content.clientHeight/content.scrollHeight;
  const pct=Math.round(scrollRatio*100);
  
  // Update minimap viewport
  const h=Math.max(20,wrapH*viewRatio);
  const top=8+scrollRatio*(wrapH-h+16);
  viewport.style.height=h+'px';
  viewport.style.top=top+'px';
  
  // Update progress bar
  $('#progress').style.width=pct+'%';
  
  // Update scroll position indicator
  $('#scroll-pos').textContent=pct+'%';
  
  // Update active section in nav
  updateActiveSection();
}

function updateActiveSection(){
  const content=$('#content');
  const scrollTop=content.scrollTop;
  let activeId=null;
  
  for(const s of state.sections){
    const el=document.getElementById(s.id);
    if(el&&el.offsetTop<=scrollTop+100)activeId=s.id;
  }
  
  if(activeId){
    document.querySelectorAll('.nav-section').forEach(s=>{
      s.classList.toggle('active',s.dataset.id===activeId);
    });
  }
}

function updateStats(){
  $('#stat-scenes').textContent=state.scenes.length;
  $('#stat-lines').textContent=state.elements.length;
}

function exportText(){
  let txt='THE REPUBLIC\nAssembled Screenplay\n\n';
  for(const el of state.elements){
    if(el.type==='scene')txt+='\n'+el.text.toUpperCase()+'\n\n';
    else if(el.type==='character')txt+='        '+el.name+'\n';
    else if(el.type==='dialogue')txt+='    '+el.text+'\n';
    else if(el.type==='action')txt+=el.text+'\n';
    else if(el.type==='witness')txt+='\n'+el.text+'\n';
    else if(el.type==='transition')txt+='\n                    '+el.text+'\n';
  }
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='THE_REPUBLIC_Screenplay.txt';
  a.click();
}

async function loadData(){
  for(const fn of FILES){
    try{
      const res=await fetch(fn);
      if(!res.ok)continue;
      const data=await res.json();
      const ex=extract(data,fn);
      if(ex.pairs.length)state.sources.push(ex);
    }catch(e){console.error(fn,e);}
  }
  
  buildScenes();
  buildElements();
  render();
  renderSections();
  renderMinimap();
  updateStats();
}

// Scroll helper
function scrollBy(delta){
  const content=$('#content');
  content.scrollBy({top:delta,behavior:'smooth'});
}

function scrollToTop(){
  $('#content').scrollTo({top:0,behavior:'smooth'});
}

function scrollToBottom(){
  const content=$('#content');
  content.scrollTo({top:content.scrollHeight,behavior:'smooth'});
}

// Events
$('#content').onscroll=updateViewport;
$('#search').oninput=e=>render(e.target.value);
$('#export-btn').onclick=exportText;

// Scroll controls
$('#scroll-top').onclick=scrollToTop;
$('#scroll-up').onclick=()=>scrollBy(-window.innerHeight*.7);
$('#scroll-down').onclick=()=>scrollBy(window.innerHeight*.7);
$('#scroll-bottom').onclick=scrollToBottom;
$('#fab-up').onclick=()=>scrollBy(-window.innerHeight*.5);
$('#fab-down').onclick=()=>scrollBy(window.innerHeight*.5);

// Keyboard shortcuts
document.onkeydown=e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='Home'){scrollToTop();e.preventDefault();}
  if(e.key==='End'){scrollToBottom();e.preventDefault();}
  if(e.key===' '&&!e.shiftKey){scrollBy(window.innerHeight*.8);e.preventDefault();}
  if(e.key===' '&&e.shiftKey){scrollBy(-window.innerHeight*.8);e.preventDefault();}
};

// Minimap click to scroll
$('#minimap-wrap').onclick=e=>{
  const track=e.currentTarget.querySelector('.minimap-track');
  const rect=track.getBoundingClientRect();
  const ratio=(e.clientY-rect.top)/rect.height;
  const content=$('#content');
  content.scrollTo({top:ratio*content.scrollHeight,behavior:'smooth'});
};

// Resize observer
new ResizeObserver(()=>{renderMinimap();updateViewport();}).observe($('#minimap-wrap'));

loadData();
</script>
</body>
</html>
